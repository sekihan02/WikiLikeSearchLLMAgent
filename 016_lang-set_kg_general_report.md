- Refarence
    - [Assisting in Writing Wikipedia-like Articles From Scratch with Large Language Models](https://arxiv.org/pdf/2402.14207)
    - [Graph Chain-of-Thought: Augmenting Large Language Models by Reasoning on Graphs](https://arxiv.org/pdf/2404.07103)
    - [A Human-Inspired Reading Agent with Gist Memory of Very Long Contexts](https://read-agent.github.io/)


```python
!pip install arxiv==2.1.0
!pip install python-dotenv tiktoken
!pip install openai==1.30.0

!pip install wikipedia==1.4.0
```

    Requirement already satisfied: arxiv==2.1.0 in /usr/local/lib/python3.10/dist-packages (2.1.0)
    Requirement already satisfied: feedparser==6.0.10 in /usr/local/lib/python3.10/dist-packages (from arxiv==2.1.0) (6.0.10)
    Requirement already satisfied: requests==2.31.0 in /usr/local/lib/python3.10/dist-packages (from arxiv==2.1.0) (2.31.0)
    Requirement already satisfied: sgmllib3k in /usr/local/lib/python3.10/dist-packages (from feedparser==6.0.10->arxiv==2.1.0) (1.0.0)
    Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests==2.31.0->arxiv==2.1.0) (3.3.2)
    Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests==2.31.0->arxiv==2.1.0) (3.6)
    Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests==2.31.0->arxiv==2.1.0) (2.2.1)
    Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests==2.31.0->arxiv==2.1.0) (2024.2.2)
    [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv[0m[33m
    [0mRequirement already satisfied: python-dotenv in /usr/local/lib/python3.10/dist-packages (1.0.1)
    Requirement already satisfied: tiktoken in /usr/local/lib/python3.10/dist-packages (0.7.0)
    Requirement already satisfied: regex>=2022.1.18 in /usr/local/lib/python3.10/dist-packages (from tiktoken) (2023.12.25)
    Requirement already satisfied: requests>=2.26.0 in /usr/local/lib/python3.10/dist-packages (from tiktoken) (2.31.0)
    Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests>=2.26.0->tiktoken) (3.3.2)
    Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests>=2.26.0->tiktoken) (3.6)
    Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests>=2.26.0->tiktoken) (2.2.1)
    Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests>=2.26.0->tiktoken) (2024.2.2)
    [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv[0m[33m
    [0mRequirement already satisfied: openai==1.30.0 in /usr/local/lib/python3.10/dist-packages (1.30.0)
    Requirement already satisfied: anyio<5,>=3.5.0 in /usr/local/lib/python3.10/dist-packages (from openai==1.30.0) (4.3.0)
    Requirement already satisfied: distro<2,>=1.7.0 in /usr/lib/python3/dist-packages (from openai==1.30.0) (1.7.0)
    Requirement already satisfied: httpx<1,>=0.23.0 in /usr/local/lib/python3.10/dist-packages (from openai==1.30.0) (0.27.0)
    Requirement already satisfied: pydantic<3,>=1.9.0 in /usr/local/lib/python3.10/dist-packages (from openai==1.30.0) (1.10.14)
    Requirement already satisfied: sniffio in /usr/local/lib/python3.10/dist-packages (from openai==1.30.0) (1.3.1)
    Requirement already satisfied: tqdm>4 in /usr/local/lib/python3.10/dist-packages (from openai==1.30.0) (4.66.2)
    Requirement already satisfied: typing-extensions<5,>=4.7 in /usr/local/lib/python3.10/dist-packages (from openai==1.30.0) (4.10.0)
    Requirement already satisfied: idna>=2.8 in /usr/local/lib/python3.10/dist-packages (from anyio<5,>=3.5.0->openai==1.30.0) (3.6)
    Requirement already satisfied: exceptiongroup>=1.0.2 in /usr/local/lib/python3.10/dist-packages (from anyio<5,>=3.5.0->openai==1.30.0) (1.2.0)
    Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from httpx<1,>=0.23.0->openai==1.30.0) (2024.2.2)
    Requirement already satisfied: httpcore==1.* in /usr/local/lib/python3.10/dist-packages (from httpx<1,>=0.23.0->openai==1.30.0) (1.0.5)
    Requirement already satisfied: h11<0.15,>=0.13 in /usr/local/lib/python3.10/dist-packages (from httpcore==1.*->httpx<1,>=0.23.0->openai==1.30.0) (0.14.0)
    [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv[0m[33m
    [0mRequirement already satisfied: wikipedia==1.4.0 in /usr/local/lib/python3.10/dist-packages (1.4.0)
    Requirement already satisfied: beautifulsoup4 in /usr/local/lib/python3.10/dist-packages (from wikipedia==1.4.0) (4.12.3)
    Requirement already satisfied: requests<3.0.0,>=2.0.0 in /usr/local/lib/python3.10/dist-packages (from wikipedia==1.4.0) (2.31.0)
    Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests<3.0.0,>=2.0.0->wikipedia==1.4.0) (3.3.2)
    Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests<3.0.0,>=2.0.0->wikipedia==1.4.0) (3.6)
    Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests<3.0.0,>=2.0.0->wikipedia==1.4.0) (2.2.1)
    Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests<3.0.0,>=2.0.0->wikipedia==1.4.0) (2024.2.2)
    Requirement already satisfied: soupsieve>1.2 in /usr/local/lib/python3.10/dist-packages (from beautifulsoup4->wikipedia==1.4.0) (2.5)
    [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv[0m[33m
    [0m


```python
!pip install langdetect==1.0.9
!pip install lingua-language-detector==2.0.2
```

    Requirement already satisfied: langdetect==1.0.9 in /usr/local/lib/python3.10/dist-packages (1.0.9)
    Requirement already satisfied: six in /usr/lib/python3/dist-packages (from langdetect==1.0.9) (1.16.0)
    [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv[0m[33m
    [0mRequirement already satisfied: lingua-language-detector==2.0.2 in /usr/local/lib/python3.10/dist-packages (2.0.2)
    [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv[0m[33m
    [0m


```python
import re
import os
import json
import warnings

import arxiv
import openai
from openai import OpenAI
from dotenv import load_dotenv
import wikipedia

# すべての警告を無視する
warnings.filterwarnings('ignore')
```


```python
def get_wikipedia_articles_for_keywords(keywords, num_articles=3, lang='ja'):
    """
    与えられたキーワードのリストに対し、各キーワードについてWikipedia記事を検索し、記事の情報を取得する。

    Parameters
    ----------
    keywords : list of str
        検索するキーワードのリスト
    num_articles : int, optional
        各キーワードに対して取得する記事の数 (default is 3)
    lang : str, optional
        使用する言語 (default is 'ja' for Japanese)

    Returns
    -------
    all_articles : list of dict
        各キーワードについて取得した記事の情報を含む辞書のリスト。
        各辞書はキーワード、タイトル、URL、記事の全文を含む。
    -------
    articles = get_wikipedia_articles_for_keywords(keywords)
    for article in articles:
        print('キーワード: ', article['keyword'])
        print('タイトル: ', article['title'])
        print('URL: ', article['url'])
        print('内容: ', article['content'])
        print('\n')
    """
    
    wikipedia.set_lang(lang)  # 言語を設定
    all_articles = []  # 全記事情報を保持するリスト

    try:
        titles = wikipedia.search(keywords, results=num_articles)  # キーワードでWikipediaを検索
        articles = []

        for title in titles:  # 取得した各タイトルに対して
            page = wikipedia.page(title)  # ページ情報を取得
            articles.append({  # 記事情報を辞書として追加
                'keyword': keywords,  # 検索キーワード
                'title': title,  # 記事のタイトル
                'url': page.url,  # 記事のURL
                'summary': page.summary,  # 記事の概要
                # 'summary': wikipedia.summary(title),  # 記事の概要
                'content': page.content  # 記事の全文
            })
        all_articles.extend(articles)  # 全記事情報リストに追加
    except wikipedia.DisambiguationError as e:  # 曖昧さ回避ページがヒットした場合のエラーハンドリング
        print(f"DisambiguationError for keyword {keywords}: {e.options}")  # エラーメッセージを出力
        
    return all_articles  # 全記事情報を返す

```


```python
load_dotenv()
```




    True




```python
openai.api_key = os.getenv("OPENAI_API_KEY")

MODEL_NAME = "gpt-3.5-turbo-0125"
# MODEL_NAME = "gpt-3.5-turbo-instruct"
# MODEL_NAME = "gpt-4-0125-preview"
# MODEL_NAME = "gpt-4-turbo-2024-04-09"

MODEL4o_NAME = "gpt-4o-2024-05-13"

TEMPERATURE = 0.7
# OpenAIクライアントの初期化
client = OpenAI()
```


```python
# message = "ディアドコイ戦争や後継者戦争とも言われる\nディアドコイ戦争について教えてください"
message = "応仁の乱について教えてください"
```


```python
def generate_search_queries(model_name, text, count):
    # テキストからWikipedia検索クエリを生成する
    
    prompt = [
        {"role": "system", "content": "You want to answer the question using search . What do you type in the search box ?"},
        {"role": "system", "content": f"Please formulate {count} distinct search queries based on the content of the Input text."},
        # {"role": "system", "content": "Please ensure that the output is in English."},
        {"role": "system", "content": "Write the queries you will use in the following"},
        {"role": "system", "content": "format :\n query 1\n query 2\n..."},
        {"role": "user", "content": f"Input text: {text}"},
        {"role": "user", "content": "format :\n"}
    ]
    
    # 概要と提案手法名抽出用のプロンプトテンプレートを作成
    response = client.chat.completions.create(
        model=model_name, # model = "deployment_name".
        messages=prompt,
        temperature=TEMPERATURE,
    )
    
    search_queries = response.choices[0].message.content
    return search_queries
```


```python
search_query = generate_search_queries(MODEL_NAME, message, "one")
search_query
```




    '応仁の乱'




```python

```


```python
from lingua import LanguageDetectorBuilder, Language

# 言語コードを取得するための辞書
language_codes = {
    'JAPANESE': 'ja',
    'ENGLISH': 'en'
}

def detect_language_for_keywords(keywords):
    # 対応する言語を指定してLanguageDetectorを構築
    languages = [Language.JAPANESE, Language.ENGLISH]
    detector = LanguageDetectorBuilder.from_languages(*languages).build()

    # 結果を保持するリスト
    results = []

    # 各キーワードに対して言語検出を行う
    for keyword in keywords:
        highest_confidence = None
        
        for confidence in detector.compute_language_confidence_values(keyword):
            if highest_confidence is None or confidence.value > highest_confidence.value:
                highest_confidence = confidence
        
        if highest_confidence:
            language_name = highest_confidence.language.name
            language_code = language_codes.get(language_name, 'unknown')
            results.append({
                'keyword': keyword,
                'language': language_code,
                'confidence': highest_confidence.value
            })

    return results

# # 使用例
# keywords = ["こんにちは", "Hello", "これはテストです", "This is a test"]
# results = detect_language_for_keywords(keywords)

# for result in results:
#     print(f"キーワード: {result['keyword']}, 言語: {result['language']}, 信頼度: {result['confidence']:0.3f}")

```


```python
keywords_list = search_query.split('\n')
print(keywords_list)

results = detect_language_for_keywords(keywords_list)
for result in results:
    print(f"キーワード: {result['keyword']}, 言語: {result['language']}, 信頼度: {result['confidence']:0.3f}")
```

    ['応仁の乱']
    キーワード: 応仁の乱, 言語: ja, 信頼度: 1.000



```python
articles_overview = []
for result in results:
    lang = result['language']
    article = get_wikipedia_articles_for_keywords(result['keyword'], num_articles=1, lang=lang)
    articles_overview.append(article)
```


```python

```


```python
articles_overview
```




    [[{'keyword': '応仁の乱',
       'title': '応仁の乱',
       'url': 'https://ja.wikipedia.org/wiki/%E5%BF%9C%E4%BB%81%E3%81%AE%E4%B9%B1',
       'summary': '応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年に及んで継続した内乱。\n室町幕府管領家の畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となり、幕府勢力が東西に分かれて争う戦乱に発展、さらに各々の領国にも争いが拡大する大乱となった。\n明応2年（1493年）の明応の政変と並んで戦国時代移行の原因とされる。\n11年に亘る戦乱は、西軍が解体されたことで収束したが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃した。\n応仁元年（1467年）に起きたことから一般に「応仁の乱」と呼ばれるが、戦が続いたことにより、応仁はわずか3年で文明へと改元された。そのため、近年では「応仁・文明の乱」（おうにん・ぶんめいのらん）と称されることもある。',
       'content': '応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年に及んで継続した内乱。\n室町幕府管領家の畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となり、幕府勢力が東西に分かれて争う戦乱に発展、さらに各々の領国にも争いが拡大する大乱となった。\n明応2年（1493年）の明応の政変と並んで戦国時代移行の原因とされる。\n11年に亘る戦乱は、西軍が解体されたことで収束したが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃した。\n応仁元年（1467年）に起きたことから一般に「応仁の乱」と呼ばれるが、戦が続いたことにより、応仁はわずか3年で文明へと改元された。そのため、近年では「応仁・文明の乱」（おうにん・ぶんめいのらん）と称されることもある。\n\n\n== 背景 ==\n\n\n=== 足利義政の8代将軍就任 ===\n鎌倉時代後期から、名門武家・公家を始めとする旧来の支配勢力は、相次ぐ戦乱の結果、力をつけてきた国人・商人・農民などの台頭によって、その既得権益を侵食されつつあった。また、守護大名による合議制の連合政権であった室町幕府は成立当初から将軍の権力基盤は脆弱で、三管領（細川氏、斯波氏、畠山氏）など宿老の影響力が強かった。それは宿老や守護大名も例外ではなく、領国の守護代や有力家臣の強い影響を受けていた。こうした環境が、家督相続の方式が定まっていなかったことも相まってしばしば将軍家・守護大名家に後継者争いや「お家騒動」を発生させる原因になった。幕府は、4代将軍足利義持の弟で、籤引きによって選ばれた6代将軍足利義教が専制政治を敷き、守護大名を抑えつけて将軍の権力を強化したが、嘉吉元年（1441年）に赤松満祐に暗殺されてしまう。この混乱を収束させたのは管領細川持之と畠山持国であった。しかし、嘉吉2年（1442年）細川持之は隠居し翌年死去、7代将軍となった義教の嫡子である9歳の義勝も就任1年足らずで急逝した。義勝の同母弟である8歳の足利義政が、管領に就任していた畠山持国邸における衆議により次期将軍に選ばれ、文安6年（1449年）に正式に将軍職を継承した。\n\n\n=== 細川氏・山名氏の連携と、管領畠山持国の隠居 ===\n管領であった畠山持国は、足利義教に隠居させられていたが、嘉吉の乱の際に武力で家督を奪還し、義教によって家督を追われた者達を復権させ勢力を拡大した。持国には子がなかったため、弟の持富を養子に迎えていた。しかし、永享9年（1437年）に義夏（後の畠山義就）が生まれたため、文安5年（1448年）に持富を廃嫡して義夏を家督につけた。これは将軍・足利義政にも認められ、義夏は義政から偏諱を授けられている。\nそして、畠山持国、足利義政、義政の乳母今参局は一致して斯波氏家臣の争いに介入し、宝徳3年（1451年）の織田郷広の尾張守護代復帰を支援した。しかしこれは越前・遠江守護代甲斐常治の意を受けた日野重子（義政の母）の反対により頓挫した。さらに、畠山家内部でも重臣神保氏・遊佐氏は持富の廃嫡に納得せず、持国の甥で持富の子弥三郎を擁立するべきと主張した（持富は宝徳4年（1452年）に死去）。\nこのため享徳3年（1454年）4月3日畠山持国は神保国宗を誅殺した。この畠山氏の内紛に対し、細川勝元、山名宗全、そして畠山氏被官の多くが、勝元と宗全の下に逃れた畠山弥三郎・政長兄弟を支持し、8月21日に弥三郎派が持国の屋敷を襲撃した。難を逃れた畠山持国は8月28日に隠居させられ、義就は京都を追われ、足利義政は弥三郎を家督継承者と認めなくてはならなかった。一方で、弥三郎を匿った細川勝元の被官の処刑も命ぜられ、喧嘩両成敗の形も取られた。しかし山名宗全はこの命令に激怒し、処刑を命令した義政とそれを受け入れた勝元に対して反発した。足利義政は宗全追討を命じたが、細川勝元の嘆願により撤回され、宗全が但馬国に隠居することで決着した。12月6日に宗全が但馬国に下向すると、13日に義就が軍勢を率いて上洛して弥三郎は逃走。再び畠山義就が家督継承者となった。\nなお、文安4年（1447年）に勝元が宗全の養女を正室として以来、細川・山名の両氏は連携関係にあった。\n\n\n=== 管領細川勝元と畠山義就の対立 ===\n翌享徳4年3月26日（1455年4月12日）に畠山持国は死去し、畠山義就が畠山氏の家督を相続した。義就は弥三郎派の勢力を一掃するため、領国内で活発な弾圧を行った。この最中、義就は義政の上意と称して軍事行動を行ったため、義政の信任を次第に失った。さらに義就は勝元の所領である山城国木津を攻撃、細川勝元は弥三郎を擁立することで義就の追い落としを計画した。一方で山名宗全は、長禄2年（1458年）に赦免され、同年に義就と共に八幡神人討伐に参陣した頃から親義就派となっていった。長禄3年（1459年）には弥三郎が赦免され、上洛を果たしたがまもなく死去。代わって政長が勝元と弥三郎派の家臣団に擁立された。\n寛正元年（1460年）9月20日には義政によって政長の畠山氏家督が認められ、義就は追放された。義就は河内嶽山城に籠もって徹底抗戦を図ったため義政は追討軍を発し、義就を攻撃させた（嶽山城の戦い）。しかし義就は寛正4年（1463年）4月15日まで攻撃を耐え抜き、嶽山城が落城した後は紀伊国、次いで吉野へ逃れた。\n\n\n=== 足利義政の関東政策と斯波氏 ===\n一方、関東では、享徳3年（1455年）に幕府に叛旗を翻し享徳の乱を起こした鎌倉公方（後に古河公方）足利成氏を討伐するため、長禄元年（1457年）足利義政は、異母兄の足利政知を新たな鎌倉公方として関東に派遣したが、政知は鎌倉へ下向できず、長禄2年（1458年）伊豆国堀越に留まった（後の堀越公方）。足利義政は斯波義敏を始めとする成氏追討軍を派遣しようとしたが、義敏が執事の甲斐常治と内乱を起こしたため更迭、息子の松王丸（義寛）を斯波氏当主に替えた。さらに寛正2年（1461年）、足利義政は斯波氏の家督を松王丸から、足利政知の執事である渋川義鏡の子・斯波義廉に替え、堀越府の軍事力強化を企図した。しかし、渋川義鏡が扇谷上杉家の上杉持朝と対立し、その後失脚したため、足利義政は斯波義敏の復権を画策した。\n\n\n=== 足利義政と政所執事 ===\n畠山氏や斯波氏の他にも、富樫氏、小笠原氏、六角氏でもお家騒動が起こっている。幕府はこれらの調停も行ったが、対応が首尾一貫せず、守護家に分裂の火種を残した。この政策は、室町幕府政所執事であり、義政側近の伊勢貞親が、将軍権力の向上を企図して主導したものであった。さらに、寛正4年（1463年）8月、義政の母日野重子が没し、大赦が行われ、畠山義就、武衛騒動で失脚した斯波義敏ら多数の者が赦免された。\nこの前後の一貫性のない幕府・朝廷の対応を興福寺別当尋尊は「公武御成敗諸事正体無し」と批判している。しかし、この大赦には、斯波義敏の妾と伊勢貞親の妾が姉妹であることや、細川勝元への牽制などの動機があった。ところが、この伊勢貞親の政策の裏では、中央から遠ざかっていた山名宗全が斯波義廉に接近、畠山義就、伊予国や安芸国で細川勝元と対立する大内政弘とも提携、反勢力の中核となっていった。\nまた、嘉吉の乱鎮圧に功労のあった山名宗全は主謀者赤松氏の再興に反対していたが長禄2年（1458年）、勝元が宗全の勢力削減のため、長禄の変で赤松氏遺臣が功績を立てたことを根拠に赤松政則を加賀守護職に取り立てたことから両者は激しく対立した。\n後に勝元が養子で宗全の末子豊久を廃嫡したことが応仁の乱の一因となったともされる。\n\n\n=== 足利義視の還俗と義尚誕生 ===\n足利義政は29歳になったが今だ子はなく、生存している足利宗家の男子は3名のみと断絶が危惧される情勢にあった。寛正5年11月26日（1464年12月24日）、義尋は還俗し名を足利義視と改めると勝元の後見を得て今出川邸に移った。まもなく義視は、義政の正室日野富子の妹である日野良子を妻に迎えたが、これは義政と富子のとりもちによるものであった。『応仁記』一巻本には義政が「男子が生まれても僧門に入れる」と義視に約束したという記述があるが、確証はない。\n寛正6年11月23日（1465年12月11日）、義政と富子との間に足利義尚（後に義煕と改名）が誕生する。義尚は出生当時から「世嗣」として扱われていたが、義視の後継者待遇も変わらずに順調に昇進を続けており、20歳以上離れた義尚後継までの中継ぎとして扱われていた。\n富子の依頼により山名宗全が義尚の後見人とされたという『応仁記』一巻本・三巻本の記述が従来の通説であったが、近年では反証もあげられている。実際に義尚の後見人であったのは「御父」とされた義政側近の伊勢貞親であり、むしろ宗全は赤松政則を支援する義政側近と敵対していたため、義政の早期隠退と義視の将軍就任を望む立場であった。また『大乗院寺社雑事記』には義視と宗全が共同して義就を支援していた記述が見られる。更に、細川・山名の両氏が対立関係となるのは寛正6年（1465年）から文明6年（1474年）までであり、勝元と宗全の対立を乱の原因とする理解は、『応仁記』一巻本・三巻本の叙述によるものであるとの見解も提起されている。\n\n\n=== 文正の政変 ===\n\n文正元年（1466年）7月23日、足利義政は側近の伊勢貞親・季瓊真蘂らの進言で斯波氏宗家・武衛家の家督を突然、斯波義廉から取り上げ斯波義敏に与えた。さらに8月25日には越前・尾張・遠江守護職を義敏に与え、義廉を討つよう命じている。しかし勝元はこれを拒否し、宗全も義廉について戦うと表明した。貞親ら側近衆は守護大名の抵抗により窮地に追い込まれた。\n9月5日、伊勢貞親が義政に義視の誅殺を訴える事件が発生した。義政は一旦これを認めたが、9月6日に義視は居館であった今出川殿を脱出し、宗全の屋敷を経て勝元の屋敷に移った。勝元は宗全と協力して足利義視の無実を訴えた。これを受けて義政は伊勢貞親を切腹させるよう命じた。貞親は逃亡し、季瓊真蘂、斯波義敏、赤松政則も失脚して都を追われた。有力な側近を失った義政の影響力は著しく低下し14日に斯波家の家督は斯波義廉に戻された。\n\n\n== 経過 ==\n\n\n=== 御霊合戦 ===\n\n文正元年（1466年）12月、7年前の追放以来畿内近国で抵抗・逃亡を続けていた畠山義就が大軍を率いて上洛し、千本地蔵院（京都市北区）に陣取った。これまで連携していた細川勝元と山名宗全であったが、畠山氏の継承問題を巡っては立場を異にしていたため、両畠山の抗争が再び中央に持ち込まれ緊張が高まると対立するようになる。\n年が明けて1月2日（1467年2月6日）、将軍義政は正月の恒例である春日万里小路の畠山邸（政長側）への御成を取り止めて室町第に義就を招き、さらに追い討ちをかけるように山名邸の酒宴に出席して義就・宗全側を支持する姿勢を示した。1月6日には政長の管領職を罷免し、畠山邸を義就へ明け渡すよう命じた。これに対して勝元は室町第を包囲して将軍から義就追討令を得ようと企図したが、勝元夫人（宗全の娘）が事前に宗全に情報を漏らしたため、宗全・義就・斯波義廉（管領）が先手を打って室町第を占拠し、勝元側は御所巻に失敗した。\n1月18日（2月22日）、政長は自邸に火を放って上御霊神社（京都市上京区）に陣を敷き抗戦の構えを見せた。義就は天皇や上皇らも室町第に避難させて将軍とともに抱え込み、勝元・政長・京極持清の兵がこれを御所巻にした。ここに至って将軍義政は畠山氏の私闘への関与を禁じたが、宗全や山名政豊（宗全の孫）・斯波義廉・朝倉孝景（斯波氏宿老）らはこれに取り合わず義就に加勢した。義政の命に従って政長への加勢を止めた勝元は「弓矢の道」に背くものとして非難を受けた。義就側は釈迦堂から出兵して御霊社の政長軍を攻撃した（御霊合戦）。戦いは夕刻まで続いたが、政長は夜半に社に火をかけて自害を装い逃走した。勝元邸に匿われたといわれる。\n\n\n=== 大乱前夜 ===\n\n山名宗全らが室町第を占拠したことで幕府中枢から排除された格好となった細川勝元は、御霊合戦の後も没落せずなお京都に留まり続けていた。山名方は斯波義廉（管領）の管領下知状により指令を行っていたが、勝元も代々管領職を務める細川京兆家当主の立場で独自に（管領の職務である）軍勢催促状や感状の発給、軍忠状の加判などを自派の大名や国人に行った。そして四国など細川氏一族の分国からも兵を京都へ集結させるなどしたため緊迫した状態が続いた。3月5日に改元されて後の応仁元年（1467年）4月に細川方の兵が山名方の年貢米を略奪する事件が相次いで起き、足利義視が調停を試みている。また細川方の兵は宇治や淀など各地の橋を焼き、4門を固めた。\n宗全は5月20日に評定を開き、五辻通大宮東に本陣を置いた。両軍の位置関係から細川方を「東軍」、山名方を「西軍」と呼ぶ。『応仁記』によれば東軍が16万、西軍が11万以上の兵力だったというが、これは誇張と考えられる。京都に集結した諸将は北陸、信越、東海と九州の筑前、豊後、豊前が大半であった。守護分国の分布では、東軍が細川氏一族の畿内と四国に加えその近隣地域の自派の守護、西軍は山名氏の他に細川派の台頭に警戒感を強める周辺地域の勢力が参加していた。当初の東軍の主力は細川氏・畠山政長・京極持清・武田信賢に文正の政変で失脚した赤松政則・斯波義敏を加えた顔ぶれで、西軍の主力は山名氏・斯波義廉（管領）・畠山義就・一色義直・土岐成頼・大内政弘であった。\n\n\n=== 開戦と東軍の足利義視推戴 ===\n応仁元年（1467年）5月、東軍はかつての播磨守護赤松氏の一門赤松政則が山名分国の播磨国に侵攻し奪還した。また武田信賢・細川成之らが若狭国の一色氏の領地へ、斯波義敏が越前国へ侵攻した。美濃土岐氏一門の世保政康も旧領であった一色氏の伊勢国を攻撃している。\n\nそして、5月26日に京都での戦いが始まる（上京の戦い）。夜明け前、東軍は成身院光宣（興福寺衆徒）が室町第西隣の一色義直邸に近い正実坊を、武田信賢が実相院を占拠した。武田信賢・細川成之の軍が続いて一色邸を襲撃し、義直は直前に脱出したものの屋敷は焼き払われた。細川勝元は戦火から保護するという名目で室町第を押さえて将軍らを確保し、自邸（今出川邸）に本陣を置いた。勝元は匿っていた畠山政長を含む自派の諸将兵に応じるよう呼びかけた。また西軍についた幕府奉行衆の責任を追及し、6月11日には恩賞方を管轄していた飯尾為数が殺され、8月には伊勢貞藤（貞親の弟）が追放された。京都で開戦した26日、西軍は斯波義廉（管領）配下の朝倉・甲斐氏の兵が山名宗全邸南側の細川勝久邸を攻めて細川勢と激戦を展開し、東から援軍に来た京極持清を返り討ちにした。東軍の赤松政則は南下して正親町を通り、猪熊に攻め上って斯波勢を退け、細川勝久はこの隙を見て東の細川成之邸に逃げ込んだ。西軍は勝久邸を焼き払い、さらに成之邸に攻め寄せ雲の寺、百万遍の仏殿・革堂にも火を放ち成之邸を攻撃したが東軍の抵抗で勝敗は決せず、翌日両軍は引き上げた。この合戦による火災のため、京都は北の船岡山から南の二条通りまでの一帯が延焼した。将軍義政は28日に両軍に和睦を命じ、勝元の行動を非難しながら、義就には河内下向を指示し、また伊勢貞親に軍を率いて上洛させるなど乱の収束と復権に向けた動きを取っていた。\nところが6月3日に勝元の要請によって将軍の牙旗が東軍に下され、足利義視が総大将に推戴されたことで、戦乱は拡大する方向に向かっていく。東軍は軍事行動を再開し、6月8日には赤松政則が一条大宮で山名教之を破った。さらに将軍義政が降伏を勧告すると斯波義廉ら西軍諸将は動揺して自邸に引きこもったが、東軍は義廉邸も攻撃した。京都は再び兵火に巻き込まれ、南北は二条から御霊の辻まで、東西は大舎人町から室町までが炎上した。義廉・六角高頼・土岐成頼はいったんは降伏の意向を示したが、東軍に激しく抗戦する朝倉孝景（斯波氏宿老）の首級を条件とされたため断念した。\n\n\n=== 西軍大内政弘の入京と義視の逃亡 ===\n西軍は6月14日に大和国の古市胤栄、19日に紀伊国の畠山政国などの援軍が到着し始めたが、8月23日に周防国から大内政弘が伊予国の河野通春ら7か国の軍勢1万と水軍2千艘を率いて入京して勢いを回復した。同日天皇・上皇が室町第に避難し、一郭が仮の内裏とされた。一方では足利義視が伊勢貞親の復帰に危険を感じて出奔し、北畠教具を頼って伊勢国に逃亡した。この頃から西軍は管領下知状にかわって諸将の連署による下知を行い始めた。\n大内政弘は8月中に船岡山に陣取った。9月1日に攻めかかった武田勢を畠山義就・朝倉孝景が追い出し、武田勢が逃げ込んだ三宝院に火を放った。6日に将軍義政は再度義就の河内下向を命じたが、義就は従わず戦いを続けた。9月18日に京都郊外の南禅寺山でも戦いが起こり（東岩倉の戦い）、10月3日に発生した相国寺の戦いは激戦となり両軍に多くの死傷者を出したが、勝敗を決するには至らなかった。しかし、焼亡した相国寺跡には斯波義廉が陣取り、また義就は宗全邸の西に進出し、東軍は劣勢に立たされた。\n朝廷においては10月3日に後花園法皇が興福寺に山名宗全の追討を命じる治罰院宣を発したほか、12月5日（12月31日）に正親町三条公躬（公治）・葉室教忠・光忠父子・阿野季遠・清水谷実久ら西軍派とされた公家の官爵剥奪が決定された。彼らは富子の実家である日野家と対立関係にあった三条家の一族や縁者が多く、義視を支持していた公家達であった。\n\n\n=== 斯波義廉の管領解任 ===\n応仁2年（1468年）3月17日に北大路烏丸で大内政弘と毛利豊元・小早川煕平が交戦、3月21日には、稲荷山の稲荷社に陣を張って山名側の後方を撹乱・攻撃していた細川方の骨皮道賢が攻撃されて討死し、稲荷社が全焼した。5月2日に細川成之が斯波義廉邸を攻めたり、5月8日に勝元が宗全の陣を、8月1日に勝元の兵が相国寺跡の義就の陣を攻めていたが、戦闘は次第に洛外に移り、山科、鳥羽、嵯峨で両軍が交戦した。\n管領斯波義廉は西軍に属したものの、将軍義政から直ちに解任されなかった。将軍が主宰する御前沙汰なども管領不在のまま行われていた。だが、応仁2年（1468年）、幕府と敵対していた関東の古河公方足利成氏に義廉は和睦を提案し、山名宗全と畠山義就の連名の書状を送った。この理由については、義廉は幕府の関東政策の一環として斯波氏の当主に据えられたため、成氏と幕府の和睦という成果を挙げて家督と管領職の確保を狙ったと推定される。しかし、義政は独断で和睦を図った義廉を許さず、7月10日に義廉を解任して勝元を管領に任命、義廉の家督と3ヶ国守護職も取り上げられ、松王丸に替えられた。書状が出された月は2月から3月と推定され、相国寺の戦いの後に西軍有利の状況で義廉が動いたとされる。\n\n\n=== 義視の西軍入りと大内軍の優勢 ===\n応仁2年（1468年）9月22日、しばらく伊勢国に滞在していた足利義視は細川勝元（管領）や足利義政に説得されて東軍に帰陣した。帰京した義視は足利義尚派の日野勝光の排斥を義政に訴えたが、受け入れられなかった。さらに義政は閏10月16日には文正の政変で義視と対立した伊勢貞親を政務に復帰させ、11月10日には義視と親しい有馬元家を殺害するなどはっきりと義尚擁立に動き出した。勝元も義視擁立には動かず、かえって出家をすすめた。こうして義視は再度出奔して比叡山に登った。11月23日（12月19日）、西軍は比叡山に使いを出して義視を迎え入れて“新将軍”に奉った。正親町三条公躬、葉室教忠らも西幕府に祗候し、幕府の体裁が整った。以降、西幕府では有力守護による合議制の下、義視が発給する御内書によって命令が行われ、独自に官位の授与も行うようになった。\n一方で幕府では日野勝光、伊勢貞親ら義政側近の勢力が拡大し、文正の政変以前の状態に戻りつつあった。勝元には義視をあえて西軍に送り込むことで、親宗全派であった富子を幕府内で孤立させる目論見があったとも推測されている。以降勝元は西軍との戦いをほとんど行わず、対大内氏との戦闘に傾注していく。\n大内政弘の圧倒的な軍事力によって山城国は西軍によって制圧されつつあり（西岡の戦い）、京都内での戦闘は散発的なものとなり、戦場は摂津・丹波・山城に移っていった。このため東軍は反大内氏の活動を活発化させた。文明元年（1469年）には九州の大友親繁・少弐頼忠が政弘の叔父教幸を擁して西軍方の大内領に侵攻、文明2年（1470年）2月には教幸自身が反乱を起こしている。しかしいずれも留守居の陶弘護に撃退されたために政弘は軍を引くことなく、7月頃までには山城の大半が西軍の制圧下となった。\nこれ以降東西両軍の戦いは膠着状態に陥った。長引く戦乱と盗賊の跋扈によって何度も放火された京都の市街地は焼け野原と化して荒廃した。さらに上洛していた守護大名の領国にまで戦乱が拡大し、諸大名は京都での戦いに専念できなくなった。かつて守護大名達が獲得を目指していたはずの幕府権力そのものも著しく失墜したため、もはや得るものは何もなかったのである。やがて東西両軍の間には厭戦気分が漂うようになった。\n\n\n=== 各勢力の動向 ===\n東軍は将軍義政や後土御門天皇・後花園法皇を保護下に置き、将軍牙旗や治罰院宣を駆使して官軍の体裁を整え、西軍は賊軍の立場に置かれていた。しかし、正親町三条家・阿野家・葉室家などのように将軍姻戚の日野家と対立する公家の一部は義視とともに西軍に投じており、さらに西軍は「西陣南帝」と呼ばれた小倉宮後裔を担ぐなど朝廷も一時分裂状態に陥った。\n宗教勢力の動きでは蓮如率いる浄土真宗本願寺派の活動が知られ、文明5年に東軍の加賀半国守護・富樫政親の要請を受けて下間蓮崇率いる一向一揆が政親方に加担。本願寺派と敵対する浄土真宗高田派と結んだ西軍の富樫幸千代と戦い、翌文明6年に幸千代を破っている。ただこの一件が後に加賀一向一揆を勃発させる遠因となった。\n関東や九州では鎌倉公方や少弐氏らによりたびたび大規模な紛争が発生しており、大乱以前から長い戦乱状態にあった。室町幕府が直轄しない関東八ヶ国及び伊豆・甲斐（鎌倉府管轄）は享徳の乱の最中にあったが、将軍義政が送り込んだ堀越公方に対し、古河公方側が西軍と連携する動きもあった。文明7年には関東管領上杉顕定の後見人の越後守護上杉房定（実父）が西軍の能登守護畠山義統とともに東軍の畠山政長が領する越中を攻撃している。\n\n※スマートフォンなど携帯機種で閲覧の場合は横向きを推奨。\nその他\n\n一条兼良（関白・藤河ノ記の著者）\n一条教房（兼良の嫡男・土佐一条氏の祖）\n三条西実隆（実隆公記の著者）\n大乗院門跡尋尊（兼良の子・尋尊大僧正記の著者）\n大乗院門跡経覚（九条家の出・経覚私要鈔の著者）\n斎藤親基（武士・斎藤親基日記の著者）\n東常縁（武士・歌人）\n万里集九（禅僧・梅花無尽蔵の著者）\n雪舟（禅僧・水墨画家）\n正広（禅僧・歌人）\n専順（僧・歌人）\n宗祇（僧・歌人）\n\n\n=== 細川勝元と山名宗全の死去 ===\n文明3年（1471年）5月21日、斯波義廉（前管領）の宿老で西軍の主力であった朝倉孝景が、義政による越前国守護職補任を受けて東軍側に寝返った。本来越前守護職は斯波氏のものであったが、これが臣下のはずの朝倉氏に与えられ越前一国の支配権を公認された形となった、まさに下剋上である。西軍の主力の移籍により、東軍は決定的に有利となり、東軍幕府には古河公方足利成氏の追討を再開する余裕すらも生まれた。一方で西軍は8月、擁立を躊躇していた後南朝勢力の小倉宮皇子と称する人物を擁立して「新主」とした（西陣南帝）。同年に関東の幕府軍が単独で成氏を破り、成氏の本拠地古河城を陥落させたことも西軍不利に繋がり、関東政策で地位保全を図った義廉の立場は危うくなった。\n文明4年（1472年）になると、勝元と宗全の間で和議の話し合いがもたれ始めた。開戦要因の一つであった山名氏の播磨・備前・美作は赤松政則に全て奪還された上、宗全の息子達もかねてから畠山義就支援に否定的であり、山名一族の間にも厭戦感情が生まれていた。しかし、この和議は領土返還や山名氏の再侵攻を怖れた赤松政則の抵抗で失敗した。3月に勝元は猶子勝之を廃嫡して、実子で宗全の外孫に当たる聡明丸（細川政元）を擁立した後、剃髪した。5月には宗全が自殺を図って制止され、家督を嫡孫政豊に譲り隠居する事件が起きたが、桜井英治はこれを手打ちの意思を伝えるデモンストレーションであったと見ている。\n\n\n=== 足利義政の隠居と和睦交渉 ===\n12月19日（1474年1月7日）には義政が義尚に将軍職を譲って隠居した。幕府では文明3年に長らく空席だった侍所頭人（所司）に赤松政則が任ぜられ、政所の業務も文明5年になると政所頭人（執事）伊勢貞宗によって再開されるなど、幕府業務の回復に向けた動きがみられた。管領は義尚の将軍宣下に合わせて畠山政長が任じられたものの、一連の儀式が終わると辞任してしまい、再び空席になってしまったために富子の兄である公家の日野勝光が幕府の役職に就かないまま、管領の職務を代行した。一方で富子の勢力が拡大し、義政の実権は失われていった。\n文明6年（1474年）3月、義政は小河に建設した新邸に移り、室町第には富子と義尚が残された。興福寺別当尋尊は「天下公事修り、女中御計（天下の政治は全て女子である富子が計らい）、公方（義政）は大御酒、諸大名は犬笠懸、天下泰平の時の如くなり」と評している。だが、義政の大御酒が平時と異なったのは、室町第に退避していた後土御門天皇もその酒宴に加わっており、幕府のみならず朝廷の威信の低下にもつながる事態となっていた。\n文明6年4月3日（4月19日）、山名政豊と細川政元の間に和睦が成立。山名政豊は東軍の細川方と共に畠山義就、大内政弘らを攻撃した。さらにこの頃、西軍の一色義直の子義春が義政の元に出仕し、丹後一色氏も東軍に帰順した。その後も東軍は細川政元・畠山政長・赤松政則、西軍は畠山義就・大内政弘・土岐成頼を中心に惰性的な小競り合いを続けていた。また、赤松政則は和睦に反対し続けていた。\n一方、西軍の土岐成頼の重臣で従三位の奉公衆斎藤妙椿も文明6年の和睦に反対し、美濃の兵を率いて近江・京都・伊勢に出兵した。更に越前にも出兵し、同年6月に西軍の斯波義廉の重臣甲斐敏光と東軍に寝返っていた朝倉孝景を停戦させている。\n\n\n=== 終息 ===\n文明7年（1475年）2月、甲斐敏光が東軍に降伏し、遠江守護代に任命された。西幕府の管領で敏光の主君であった斯波義廉も同年11月、守護代織田敏広を連れて尾張国へ下国し、消息を絶った。しかし和平工作を行っていた日野勝光が死去したため、和睦の流れは一時頓挫した。翌文明8年（1476年）9月には、足利義政が西軍の大内政弘に「世上無為」の御内書を送り、12月には足利義視が足利義政に恭順を誓い、義政も義視の罪を不問に付すと返答し、和睦の流れが加速した。\n主戦派の畠山義就は大内政弘の降伏によって孤立することを恐れ、文明9年（1477年）9月22日に河内国に下国した。11月3日、大内政弘は東幕府に正式に降参し、9代将軍足利義尚の名で周防・長門・豊前・筑前の4か国の守護職を安堵された。大内軍が11月11日（1477年12月16日）に京から撤収し、能登守護の畠山義統や土岐成頼も京の自邸を焼き払って帰国した。義視・義材（後の10代将軍）親子は正式な赦免を受けないまま、土岐成頼や斎藤妙椿と共に美濃国に退去した。こうして西軍は解体され、9日後の11月20日、幕府によって「天下静謐」の祝宴が催され11年に及ぶ京都における大乱の幕が降ろされた。なお、西陣南帝は「諸将みな分国に帰り、京都に置き去りにされてしまわれた」とされているものの、その後の消息は不明。\nこの戦乱は延べ数十万の兵士が都に集結し、11年にも渡って戦闘が続いた。しかし惰性的に争いを続けてきた挙句、勝敗のつかないまま終わった。主だった将が戦死することもなく、戦後罪に問われる守護もなかった。西軍の最大勢力であった大内政弘も富子へ賄賂を贈り、守護職を安堵されていた。\n\n\n=== 畠山義就の赦免 ===\n西軍が消滅したとはいえ、それは単に京都での戦闘が終結したということに過ぎなかった。畠山義就は京都での退去後にも幕府の命令に従わず、河内国を占拠して政長方を駆逐し、続いて大和国に侵攻した。さらに義就は政長が守護を務めていた山城国に侵攻した。文明14年（1482年）末から文明15年（1483年）にかけては義就が宇治以南の南山城を占拠し、幕府の命令が届かない状態となった。将軍義尚や富子は政長を見限って義就を赦免しようとしたが、義政の反対で中止された。ついに文明16年（1484年）には政長の守護職を解き、幕府の直轄（御料国）としたが、戦乱はなおも続いた。\n文明17年（1485年）7月、義就方の斎藤彦次郎が政長方に寝返ったことにより、義就方と政長方の大軍が対峙することになった。しかし山城国の国人が団結し、撤退しなければ攻撃すると両軍に通達し、義就・政長らは山城国より撤退した。以降、国人たちは山城国一揆を組織し、一種の自治的な政権をつくることとなる。一方で義就は山城国より撤退したことが評価され、文明18年（1486年）3月に義政と義尚から正式に赦免され、応仁の乱の戦後処理はここに完了した。\n\n\n== 戦乱の影響 ==\n応仁の乱は幕府権力が崩壊した戦国時代の始まりであるとの説が通説であったが、近年では幕府の権威は明応の政変頃まで一応保たれていたという見解もあり、明応の政変以降を戦国時代の始まりととらえる説もある。とはいえ、応仁の乱以降身分や社会の流動化が加速されたことは間違いない。\n東洋史学者の内藤湖南は講演『応仁の乱に就て』において、応仁の乱前後を「最も肝腎な時代」であると指摘し、「大体今日の日本を知る爲に日本の歴史を研究するには、古代の歴史を研究する必要は殆どありませぬ、応仁の乱以後の歴史を知つて居つたらそれで沢山です」と発言し、古代史学者との間に論争を巻き起こした。なお後述するように歴史資料が失われたことで、応仁の乱以前には不明な点も多い。\n\n\n=== 幕府・守護権力の変化 ===\n応仁の乱により、多賀高忠、浦上則宗、斎藤妙椿、尼子清定など、守護家に迫る勢力を有する国人が台頭した。また、東西両軍は味方を得るために、それまでの家格を無視した叙任を行った。西軍は一介の国人であった越智家栄を大和守護に任命し、東軍は西軍の有力武将だったが守護代でもなかった朝倉孝景を越前守護につけた。\n文明7年、能登守護畠山義統と越後守護上杉房定が政長の分国越中を侵略した際には、足利義政が「諸国の御沙汰は毎事力法量（諸国の沙汰は力次第である）」と述べ、守護が他国を侵略することも是認された。このため室町幕府の家格秩序は崩壊し、身分秩序が流動化することになった。また長期にわたる京都での軍事活動により、守護の財政は逼迫した。権威と財政を失った守護は、国人や家臣団に対する支配力を著しく低下させた。国人や家臣は守護の影響を排除して自らの地盤を固め、領主化していった。\nそれまで在京が原則であった守護は自らの領国を守るため下国し、守護代に任せていた領国経営を自らの権威により行おうとした。これにより守護は幕府の統制を離れ、幕府は段銭などの徴収がままならなくなった。いくつかの守護は領主化を強化することで戦国大名へと成長することが出来たが、既に乱の最中に守護代や家臣に権力を奪われた者もおり、没落した守護も多かった。この従来の家格秩序を破る風潮は下克上と呼ばれ、戦国時代を象徴する言葉となる。\nまた、守護在京制の崩壊により、文明18年（1486年）には京都に残る守護が摂津・丹波を基盤とする細川氏一門のみとなった。守護の協力を得られなくなった幕府は、将軍近臣の奉公衆や奉行衆による運営を余儀なくされ、畿内政権としての道を歩み始めた。その一方で、細川勝元が幕府を西軍方に占拠されていた時に始めた、細川京兆家当主としての軍勢催促状などの軍事決裁行為が管領復帰後も継続され、勝元没後に管領となった畠山政長も義就との戦いのためにほとんど在京しなかったために、勝元の子政元が細川政国の後見を受けて同様の措置をもって幕府の軍事行動を指揮したため、細川京兆家が本来管領が有していた幕府の軍事的権限を行使するようになった。やがて細川氏と幕府の利害が対立し、明応の政変とその後の京兆専制を招くことになる。\n\n\n=== 公家の没落 ===\n領主化を推進する守護や国人によって一円知行化が進められ、公家や寺社の荘園は横領された。さらに幕府の権威低下により、遠国など幕府の権力が届かない地域の荘園・国衙領支配は絶望的になり、荘園制度の崩壊が加速した。収入を断たれた公家は没落し、朝廷行事や官位昇進への興味も失った。甘露寺親長は日記に「高官無益なり」と書き記し、文明5年には顕官である近衛大将の希望者が現れないという事態が発生している。前関白一条教房のように京都を去る公家や、町広光のように家を意図的に断絶させる公家まで現れた。また、西軍について失脚した西川房任の子孫が細川高国に仕えて薬師寺国長の寄子に付けられるなど、生活が立ち行かなくなって公家身分を棄てる例もあった。更に朝廷収入も激減し、即位礼や大喪の礼などの儀式を行うことも困難となった。このため戦国期には献金による売官が行われるようになった。これは京都文化が地方に伝播する一因ともなった。\n\n\n=== 京都の被害 ===\n文明2年頃には戦火で京都の寺社や公家・武家邸の大半が消失し、罹災を免れたのは土御門内裏などわずかであった。このため類聚国史（一部）など京都にあった歴史的資料の多くが焼失・散逸し、これ以前の歴史研究に影響を及ぼした。\n京都七口関は両軍の争奪戦となり、物資の流入も停滞した。さらに足軽の放火・略奪が追い打ちをかけ、京都の大半の人々は大いに困窮した。また文明5年には疫病が流行し、宗全や勝元も命を落とした。\nしかし、義政はこれを顧みず日夜酒宴に明け暮れ（ただし、これは将軍御所に退避した天皇に対する饗応の意味もある）、小河邸や東山山荘を造営した。また富子は困窮した東西軍の守護に金銭を貸し付けるほか、米の投機を行って大いに利益を上げた。\n寺社、公家、武家屋敷があった上京が焼け、商工業者が居住していた下京が焼け残ったことは、その後の京都の商業勃興をもたらした。\n\n\n=== 京都の復興 ===\n応仁の乱によって京都を追われた公家や民衆は京都周辺の山科や宇治、大津、奈良、堺といった周辺都市や地方の所領などに疎開していった。応仁の乱後の文明11年（1479年）に室町殿や内裏の造営が開始されたが、都市の荒廃による環境悪化によって疫病や火災、盗賊、一揆などの発生が頻発したこと、加えて在京していた守護大名やその家臣達（都市消費者として一定の役割を果たしていた）が領国の政情不安のために帰国したまま帰ってこなかったこともあり、京都の再建は順調とは言えなかった。また、こうした災害を理由とした改元（長享・延徳・明応）が相次いだ。\n将軍義政は、義教の死後中断していた勘合貿易を宝徳3年（1451年）に復活させた。勘合貿易の復活や側近の守護大名及び幕府官僚の財政再建によって、応仁の乱前の幕府財政は比較的安定してはいた。だが、義政は幕府財政を幕府の権威回復や民衆の救済にではなく、趣味の建築や庭園に費やした。結果、応仁の乱後の京都の復興は大幅に遅れることとなった。\n一方で、町衆主導によって行われたと評価されてきた明応9年（1500年）の祇園祭の再興も本来祇園祭が疫病平癒の祭りであったことを考えると、逆に当時の社会不安の反映が祇園祭再興を促したという側面も考えられる。また、当時町衆における法華宗の受容も、社会不安からくる信仰心の高まりと関連づけられる。\nそれでも明応7年（1498年）頃より京都の住民に対する地子銭徴収が次第に増加していったこと、永正5年（1508年）以後の酒屋役徴収の強化命令が幕府から出されている事からこの時期に京都の人口回復が軌道に乗り出したと考えられ、明応9年の祇園祭の前後数年間が京都の本格的な復興期と考えられている。\n\n\n=== 戦術の変化 ===\n応仁の乱の戦いで特徴的とされるものは、正規の武士身分ではない足軽の活躍である。それまでは騎乗の権利の有する正規の武士が、少数の従卒を率いる小グループ同士の戦いであり、戦いの進行も名乗りを上げた後、騎射、馬上で薙刀などを使う打物戦、最後に下馬しての徒戦という順に進んでた。\n応仁の乱は大規模な戦闘が続いたことで兵力不足に悩んだ両軍は、兵站や土木作業に従事する足軽を戦力に加えた。足軽は技量が低い者も多く、それまではタブーであった馬への攻撃も行われた。主力武器も個人戦向けの薙刀から、集団戦に適した槍へと移行した。\n東軍の足軽大将骨皮道賢や西軍の御厨子某は、後方攪乱として足軽によるゲリラ戦を行って名を上げるなど散兵も活用された。\n足軽は盗賊などの無法者を多く含んでおり、高い自立性を持っていた。彼らは異形の装いをし、市街の放火や略奪を頻繁に行った。このため一条兼良は『樵談治要』において「洛中洛外の諸社諸寺五山十刹公家門跡の滅亡は彼らが所行なり」と非難している。一方で東寺などの権門寺社も自衛のために足軽を雇用することもあった。\n\n\n== 後世の評価と研究 ==\n\n\n=== 拡大の要因 ===\n乱のきっかけは畠山義就を山名宗全が支援したことであるが、何故ここまで乱の規模が拡大し、長期間継続したのかという問題には様々な解釈が建てられている。\n多くの大名には陣営を積極的に選ぶ理由はほとんど無かった。富子は義視が西軍に逃亡した後も土御門内裏が炎上しないように西軍の大内政弘と連絡を取り合っているなど、将軍継嗣の問題だけでは説明がつかないという見方もある。永原慶二は幕政の中心人物である勝元と宗全が争ったため、結果的に幕政に関与していた諸大名は戦わざるを得なくなったとしており、戦い自体にはさしたる必然性もなく、戦意がない合戦が生み出されたとしている。\n当時の人々も理解できなかったらしく、尋尊は「いくら頭をひねっても応仁・文明の大乱が起こった原因がわからない」と「尋尊大僧正記」に記している。\n\n\n=== 軍記による描写 ===\n応仁の乱が描かれた代表的な軍記物としては、『応仁記』『後太平記』『瓦林正頼記』などがある。特に、著名な軍記物語である『応仁記』は、細かい描写がなされて乱の研究に欠かせない史料であるが、儒教的色彩が濃く、幾つかの誤りが指摘されるようになった。実子・足利義尚の将軍職擁立を切望する日野富子が山名宗全に依頼し、足利義視の将軍職就任を阻止しようと暗躍したという説は誤りであるとされ、富子が乱の元凶であったとする説を現在にまで流布させる要因となった。\n\n\n== 各地の戦乱 ==\n\n\n=== 摂津・河内・和泉・山城 ===\n摂津・河内・和泉（摂河泉と呼ばれる）3ヶ国のうち摂津・和泉は細川氏が、河内は畠山氏が守護を務めていた。しかし、畠山氏がお家騒動で混乱し、応仁の乱で大内政弘が西上して京都の戦闘が各地に及ぶと、近郊の摂河泉は東西両軍の衝突地域となっていった。また、山城国は畠山氏の領国であるが、細川勝元が畠山持国への対抗から山城国人を被官に加え、畠山持国の弱体化を目論みお家騒動を煽った影響で山城国は義就と政長どちらに付くかで分裂した。\n畠山義就は乱直前の足利幕府への工作で守護職を取り戻し、御霊合戦で畠山政長を破り立場を固めた。ところが、政長を援助していた細川勝元が諸国の軍勢を動員すると、幕府から守護職を取り上げられ政長に替えられ、再び地位を失うと義就は実力行使で領国奪取に動いた。一方、大内軍は上洛して西軍の主力として京都で東軍と戦っていたが、文明元年4月に義就が山城国西岡を攻めて陣取っていた西軍を丹波国へ追い落とし（西岡の戦い）、山城勝竜寺城へ入って摂津・丹波付近を伺うようになると、大内軍も7月に摂津国へ侵攻して諸城を落とし、摂津の殆どを制圧した。しかし、池田城だけは城主の抵抗で持ちこたえ、10月に山名宗全の次男の山名是豊と赤松政則が東軍の援軍として大内軍を撃破して兵庫を奪還したため、大内政弘は池田城の包囲を解いて東軍迎撃に向かった。これに対し、是豊は摂津神呪寺に着陣して大内軍と戦い、その後は東進して摂津と山城の国境の山崎に布陣した。\n文明2年1月から4月にかけて山崎の是豊と勝竜寺城の義就が交戦したが決着は着かず、5月に東軍の裏工作で摂津国に留まっていた大内政弘の家臣仁保弘有が寝返り、直後に茨木城と椋橋城が東軍に奪回され反撃の契機となった。一方、大内政弘は南山城の木津川流域を攻撃目標として7月に八幡へ進出して木津を除く南山城を制圧した。だが、木津に拠点を構える東軍の抵抗は激しく、大内軍は木津を奪えないまま下狛（精華町）に待機して一進一退の状況を続けていった。義就は8月に山城国から大和国を経て河内国へ侵攻、若江城と誉田城を包囲したが落とせず撤退、山名是豊は領国の備後で西軍が蜂起したため12月に下向していった。山城国は山名是豊が東幕府から守護に任じられていたが、大内軍による南山城の占拠や是豊が備後国への撤退後は義就が実力で山城を支配することになり、守護でないにもかかわらず義就は山城国を実質上占領下に置いた。\n文明3年6月、大内軍と畠山軍が合流して摂津・和泉に侵入したが、敵の反撃で失敗、以後畿内で大きな戦闘はほとんど行われず、文明4年10月に木津から出陣した東軍は大内軍の反撃で退散、文明7年4月に大内軍が木津へ攻撃して失敗したことが挙げられる程度であった。文明8年に政長は家臣の遊佐長直を河内国に下向させて若江城に赴任させたが、義就は翌文明9年9月に河内へ向かい、9月から10月にかけて若江城を始めとする河内の諸城を陥落させ長直を追放、河内を制圧した（若江城の戦い）。大内軍も呼応して木津を落としたが、大内政弘は幕府と和睦して11月に帰国したため、木津と摂津は東軍の手に戻された。以後、南山城は政長を始めとする幕府が領有したが、河内は守護ではない義就が占拠した状態が続いていくことになる。\n\n\n=== 大和 ===\n大和国も畠山持国の影響力が強かったため、大和国人もお家騒動で互いに敵対していった。義就に就いた国人は越智家栄・古市胤栄で、政長には筒井順永・成身院光宣・十市遠清・箸尾為国らが味方した。光宣は乱勃発直後から政長に仕え、御霊合戦後に政長を勝元の屋敷へ手引きして、文明元年に亡くなるまで東軍に属していた。古市胤栄は義就に手助けすべく応仁元年6月に上洛したが、他の国人衆は表立って活動は行わなかった。\n事態が動いたのは文明2年に大内軍が摂津国から南山城へ南下した時で、山城国と大和国を結ぶ重要拠点の木津を大内軍が攻めてきたため、筒井順永は木津防衛に向かい大内軍の進出を阻止した。一方、越智家栄は義就の河内侵攻に参加、古市胤栄は下狛の大内軍陣地に合流して順永と交戦、文明3年になると十市遠清も東軍方として動き、1月に近江の東軍を助けて西軍の六角高頼軍を撃破、6月に順永・遠清・箸尾為国が畠山軍の河内侵攻を阻止するなど大和国人の殆どが乱に参戦するようになった。\n文明4年10月に順永は下狛の大内軍に夜襲を仕掛けたが逆襲に遭い敗走、文明5年の和睦でも戦乱は止まず、文明6年になると大和国人衆の紛争が続出して戦乱は大和に拡大していった。文明7年4月に大内軍の木津攻撃を順永が撃退、5月に大和春日社頭で順永・遠清・為国ら東軍と家栄・胤栄ら西軍が衝突して東軍が勝利、古市胤栄は敗北の責任を取り隠居、弟の澄胤に家督を譲った。また、文明8年に筒井順永が亡くなり嫡男の順尊が後を継いだ。\n文明9年に義就が河内国に侵攻・制圧すると大内軍も木津を攻撃し、木津を守る順尊ら政長派は木津を放棄、本拠地も失い没落したため、戦乱の末に大和国は越智家栄・古市澄胤ら義就派が勝利して大和は義就の手に入った。大和国は興福寺が支配していたが、大乱に伴う分裂で国人衆の台頭を抑えられず権威が下降した。興福寺別当の尋尊は日記で戦闘を詳細に書き記す一方で、混乱を収められない無力さを嘆いている。以後、没落した政長派は潜伏して遊撃兵として義就派への抵抗を続け、大和は義就派と政長派が抗争を繰り返していった。\n\n\n=== 近江・美濃 ===\n近江国は京極氏と六角氏それぞれが治めていたが、六角氏も幕府の介入でお家騒動が悪化・分裂したため京極持清が東幕府の支援を得て近江の六角高頼を攻撃、高頼は美濃国の斎藤妙椿の後ろ盾で対抗していった。京極持清・勝秀父子は高頼の従兄の六角政堯と共に高頼の居城である近江観音寺城に度々攻め入り、高頼も応戦した。美濃国では守護の土岐成頼は西軍に加わるため上洛、守護代の斎藤利藤は幼いため叔父の斎藤妙椿が後見役として実質的に美濃を治めていたが、西美濃の国人長江氏・富島氏は京極氏と組んで妙椿に反乱を起こした。\n美濃国の内乱は応仁2年までに妙椿に鎮圧されたが、近江国は決着が着かず一進一退、観音寺城が東軍に奪われては西軍に奪回されることが繰り返されていった。しかし、応仁2年に勝秀が死去、続いて文明2年に持清も亡くなり京極氏はお家騒動で2つに割れて弱体化（京極騒乱）、勝秀の弟政光と家臣の多賀清直・宗直父子は勝秀の遺児乙童子丸を擁立して西軍に寝返り、政光の弟政経と多賀高忠は乙童子丸の弟孫童子丸を擁立して争った。文明3年に政堯が高頼に討ち取られると戦況は西軍に傾き、文明3年と4年に妙椿が高頼に援軍を派遣して東軍を圧迫する。文明5年3月に宗全が亡くなると、妙椿は上洛して宗全に代わる西軍の指導者に成り上がった。\n追い詰められた東軍は、信濃国の小笠原家長・木曾家豊に美濃の背後を突くよう要請、合わせて富島氏の再起を促し挟撃を図った。妙椿は直ちに反乱を押さえ伊勢国に出陣して東軍を牽制し、11月に出陣した小笠原家長らに東美濃を占拠されるという痛手を被ったが、文明7年1月に妙椿は信濃勢に勝利してそれ以上の侵略を阻止した。一方、京極氏は文明3年に孫童子丸が、4年に政光が没して政経が当主となったが、乙童子丸・清直父子が北近江、高頼が南近江を確保していたため東軍は劣勢となった。\nそして、文明7年10月に近江国で決戦となり、妙椿の援軍と合流した高頼が勝利を収め、近江における戦乱は終結した。幕府も乙童子丸・清直父子と高頼及び成頼・妙椿らと文明10年（1478年）に和睦してそれぞれの支配を認めた。しかし、京極騒乱は収まらず政経は抵抗を続け、幕府も後に態度を翻して近江出兵を強行したり（長享・延徳の乱）、乙童子丸から家督を取り上げ政経に与えたりしていた。美濃国でも妙椿没後に実権を握った甥の妙純と利藤が争ったり（文明美濃の乱）、成頼の後継者を巡り内乱が発生したため（船田合戦）、近江と美濃の戦乱はなおも続いていくことになる。\n\n\n=== 越前・尾張・遠江 ===\n越前・尾張・遠江3ヶ国は斯波氏領国であるが、畠山氏と同じくお家騒動と家臣団の内乱で戦争状態となっていた。義敏は乱直前に3ヶ国守護に復権したが、文正の政変で守護職を失い義廉が守護に戻った状態で乱が勃発、義敏は越前国に入り義廉派と交戦、義廉は京都で家臣の朝倉孝景・甲斐敏光らと共に東軍と戦っていた。特に朝倉孝景の活躍は目覚しく、御霊合戦では義就に加勢して政長軍を破り、一条大宮の戦いでも戦果を挙げて東軍から討伐対象に挙げられていた程であった。\nしかし、朝倉孝景に対して東軍が応仁2年から内応工作を始めると、孝景は閏10月に義敏征伐を口実に越前国に下る一方で東軍と裏交渉を行い、文明3年5月21日に孝景の越前守護職任命を記した足利義政と細川勝元の書状が届き、孝景は公然と東軍に寝返った。これにより朝倉孝景は斯波義敏と同陣営に属することになるが、両者はかつて長禄合戦で敵対していたため、共同戦線を張れないことを察した足利義政は義敏に中立を命じたため、義敏の家臣が孝景に味方しても義敏本人は合戦に参加しなかった。また、応仁2年に斯波義廉は関東との秘密交渉の発覚で足利義政から管領と守護職を取り上げられ（西幕府では存続）、細川勝元と義敏の息子松王丸がそれぞれ管領と守護職に就任した。甲斐敏光は義廉の陣営に留まっていたが、孝景の寝返りを知ると越前へ下向した。\n越前では朝倉孝景と甲斐敏光が中心となり合戦を繰り広げていったが、東幕府の支持を得た孝景が有利であり、文明4年8月に甲斐敏光の本拠地である府中（越前市）を落として甲斐敏光を加賀へ追い落とし、残党も翌文明5年8月の合戦で討ち取った。甲斐敏光は挽回を図り文明6年閏5月に富樫幸千代の援助で再度越前に攻め入るが、朝倉軍に連敗を続けた末に斎藤妙椿の斡旋で孝景と和睦、越前奪還を諦めた。\n朝倉孝景の越前統一は間近に迫ったが、文明7年4月に孝景の急成長に危機感を抱いた義敏が大野郡土橋城に籠城して国人二宮氏と結託、孝景は義政から義敏の保護を命じられていたため迂闊に土橋城を攻撃出来ず、大野郡の占拠は長期間に亘った。7月に孝景は二宮氏を土橋城外に誘き出して討ち取り、11月に土橋城の攻撃を開始したため、義敏は観念して12月に降伏、孝景の処置で京都に送り返され越前は孝景に平定された。\n甲斐敏光は文明7年2月に松王丸（元服して義良と改名）と共に上洛して足利義政から遠江守護代に命じられ下向、朝倉孝景に続いて甲斐敏光にも見捨てられた斯波義廉は11月に残された領国・尾張に向かったが、尾張でも内乱が発生、文明10年に幕府から反逆者と指名されたのを最後に消息を絶った。遠江では駿河守護今川義忠が東軍の命令を受けて文明5年から遠江へ侵攻していたが、文明7年に甲斐敏光が東軍から守護代に任命されると大義名分を失い、文明8年に今川義忠が戦死すると今川氏は後継者に嫡男龍王丸（後の今川氏親）と従弟の小鹿範満が擁立されお家騒動が発生、遠江侵攻は中断された。\n斯波義良は応仁の乱終結後は越前の奪還を図り、文明11年（1479年）に甲斐敏光と二宮氏などを連れて越前に攻め入った。文明13年（1481年）に孝景は亡くなったが、後を継いだ息子氏景は斯波軍を越前から追い出し完全平定を果たした。義良も越前奪回を諦め文明15年（1483年）に尾張へ下向、甲斐敏光も朝倉氏景と和睦して越前は朝倉氏、遠江は甲斐氏、尾張は織田氏がそれぞれ守護代として受け持つことを取り決めた。かくして越前は朝倉氏が実質的に領有を果たし、斯波氏と甲斐氏は尾張・遠江を拠点としたが、やがて今川氏親と織田氏の勢いに押されていった。\n\n\n=== 播磨・備前・美作 ===\n播磨・備前・美作は元は赤松氏領だった所を山名宗全・山名教之・山名政清ら山名一族が嘉吉の乱で奪い取った経緯があり、再興を目指す赤松の遺臣達にとって山名氏との衝突は避けられなかった。長禄の変で赤松郎党が手柄を立てたことにより、赤松政則は細川勝元の支援で加賀半国守護に就任して復権の足掛かりを築き、赤松政則は家臣の浦上則宗と共に義政の警固や屋敷建造、土一揆鎮圧などに努め義政の側近として重用された。宗全からは敵視され文正の政変で失脚したが程無く復帰、応仁の乱では在京して則宗と共に西軍と戦った。\n播磨3ヶ国では宗全を始めとする山名一族は軍勢を引き連れて上洛したため、好機と捉えた宇野政秀ら赤松氏家臣団は3ヶ国の奪還に動き出した。乱勃発直後の応仁元年5月に宇野政秀は播磨に下向して赤松氏遺臣の蜂起を促し、播磨を手に入れると備前・美作にも侵攻し備前も奪回したが、美作は守護代の抵抗が強く一度敗退、完全平定まで3年後の文明2年までかかった。この間、宇野政秀は文明元年に摂津で山名是豊と合流して池田城の救援に赴き大内軍を撃破、兵庫を奪還している。また、乱における活躍で赤松政則は東軍から3ヶ国の守護に任じられ、赤松氏の再興に大きく前進した。\n文明6年に細川氏と山名氏は単独で和睦を結び戦争から離脱した。赤松政則は和睦に反対したが、文明9年の終戦で3ヶ国守護と侍所頭人の地位を保証され赤松氏の再興を果たし、側近の浦上則宗も侍所所司代として赤松氏の重臣に成り上がった。しかし、山名氏は和睦で失った3ヶ国の奪還を狙い、宗全の後を継いだ山名政豊は播磨を伺い、赤松政則も山名氏領国の不満分子を嗾けて反乱を起こさせたため、両者は終結後も3ヶ国を巡り争奪戦を繰り広げていった。\n\n\n=== 備後・安芸 ===\n備後は宗全の次男山名是豊が治めていたが、宗全と不仲であった所を勝元に籠絡され、山名氏の大半が西軍に属したのと異なり唯一東軍に与した。安芸国は大内氏と武田氏の対立の場となっていて、安芸国人の殆どを勢力下に収める大内氏に対し、武田氏は大内氏に危機感を抱く細川氏の支援で対抗した。文安4年に安芸国で最初の衝突が発生、これ以後は大内氏が度々安芸に侵攻しては勝元が武田氏と反大内の国人を支援して侵略を阻止していった。伊予国で大内氏が河野氏を支援したことも勝元が大内氏と対立する原因となった。\n乱勃発で大内政弘は宗全の要請で領国周防から出陣、応仁元年7月20日に兵庫に上陸して8月23日に上洛、西軍と合流して東軍の脅威となった。対する武田信賢・国信兄弟と毛利豊元・吉川経基・小早川煕平ら反大内の安芸国人は東軍に加わり、是豊も上洛して東軍と合流した。上洛せず安芸・備後に留まった国人勢力も二分されそれぞれ争ったが、備後は宗全の影響力が健在だったため東軍が不利で、応仁2年11月に是豊が一時帰国しなければならない程であった。文明元年に是豊は再び上洛、その途上で摂津の大内軍を破り山崎に布陣して翌文明2年西軍と交戦、備後が西軍の加勢でまたもや劣勢になったため12月に帰国した。一方の武田信賢らは京都に留まり西軍と戦った。\n文明3年になると信賢と国信の弟で安芸の留守を守っていた武田元綱が西軍の工作で反乱を起こし、毛利豊元も大内氏に誘われて安芸に帰国すると西軍に寝返り、安芸・備後は西軍有利に傾いた。東軍は国人衆に忠誠を誓わせ寝返り防止に努め、山名是豊も備後で転戦して形勢を立て直そうとしたが、文明5年から文明7年の2年間西軍の小早川弘景ら安芸・備後国人衆が東軍方の小早川敬平が籠城する高山城を包囲したにもかかわらず救援に来なかったことから人望を失い、備後から追放され消息を絶った。文明7年4月23日に安芸・備後の東西両軍は和睦を結び、中国地方の戦乱は終息に向かった。\n戦後備後は山名是豊の甥（弟とも）に当たる山名政豊が領有することになり、残党は政豊に討伐された。安芸は武田氏を始め国人が割拠する状態に置かれ、武田元綱は文明13年に信賢の後を継いだ武田国信と和睦、安芸の国人領主として兄から独立し大内氏と友好関係を結んだ。他の国人衆も大内氏との対立を解消し安芸は平穏になったが、戦乱を通して大内氏の影響力は増大、備後で山名政豊と国人が対立して支配が揺らいだため、大内氏と新たに台頭した尼子経久が国人衆を巻き込み衝突していった。\n\n\n== 脚注 ==\n\n\n=== 注釈 ===\n\n\n=== 出典 ===\n\n\n== 参考文献 ==\n\n\n=== 中央関係 ===\n榊山潤、1960年、『応仁の大乱』、河出書房新社\n永島福太郎、1968年、『応仁の乱』、至文堂\n鈴木良一、1973年、『応仁の乱』、岩波新書 ISBN 4004131006\n永原慶二、1979、『下克上の時代』、中公文庫〈日本の歴史10〉 ISBN 978-4122000780\n安田元久編、1985年、『鎌倉・室町人名事典』、新人物往来社 ISBN 4404013027\n阿部猛・西村圭子編、1987年、『戦国人名事典』、新人物往来社 ISBN 4-404-01412-0\n笠原一男、1991年、『室町幕府と応仁の乱』、木耳社\n小川信、1994、『山名宗全と細川勝元』、新人物往来社 ISBN 4404021062\n宮本義己、1994年、『応仁の乱に生きる』上・下、日本放送出版協会\n辻川達雄、1996、『蓮如と七人の息子』、誠文堂新光社 ISBN 4-416-89620-4\n森茂暁、1997、『闇の歴史 後南朝 後醍醐流の抵抗と終焉』、角川選書\n桜井英治、2001、『室町人の精神』、講談社学術文庫〈日本の歴史12〉 ISBN 978-4062689120\n川岡勉、2002年、『室町幕府と守護権力』、吉川弘文館 ISBN 4-642-02814-5\nドナルド・キーン、2003、『足利義政 - 日本美の発見』、中央公論新社 ISBN 978-4120033575\n早島大祐、2006年、『首都の経済と室町幕府』、吉川弘文館 ISBN 4642028587\n石田晴男、2008、『応仁・文明の乱』、吉川弘文館〈戦争の日本史9〉 ISBN 978-4-642-06319-7\n福島克彦、2009、『畿内・近国の戦国合戦』、吉川弘文館〈戦争の日本史11〉\n吉田賢司、2010、『室町幕府軍制の構造と展開』、吉川弘文館 ISBN 978-4642028899\n木下昌規、2014年、『戦国期足利将軍家の権力構造』、岩田書院 ISBN 978-4-87294-875-2\n呉座勇一、2016、『応仁の乱 戦国時代を生んだ大乱』、中公新書 ISBN 978-4-12-102401-5\n家永遵嗣「足利義視と文正元年の政変」『学習院大学文学部研究年報』61号、2014年。 \n日本史史料研究会（監修） 著「足利義政（執筆・下川雅弘）、足利義視（執筆・西島太郎）、足利義尚（執筆・木下聡）、足利義稙（執筆・西島太郎）」、平野明夫 編『室町幕府全将軍・管領列伝』星海社、2018年。ISBN 978-4065136126。 \n\n\n=== 地方関係 ===\n岐阜県編、1969、『岐阜県史 通史編 中世』、岐阜県\n兵庫県編、1978、『兵庫県史 第三巻』、兵庫県\n大阪府史編集専門委員会編、1981、『大阪府史第4巻 中世編 2』、大阪府\n広島県編、1984、『広島県史 中世 通史』、広島県\n戦国合戦史研究会、1988年、『戦国合戦大事典 五』、新人物往来社\n岡山県編、1991、『岡山県史 第五巻 中世II』、岡山県\n朝倉弘、1993、『大和武士』、名著出版〈奈良県史11〉\n福井県編、1994、『福井県史 通史編2 中世』、福井県\n静岡県編、1997、『静岡県史 通史編2 中世』、静岡県\n宮島敬一、2008、『浅井氏三代』、吉川弘文館〈人物叢書〉\n\n\n== 関連作品 ==\n日野富子 - 世界文化社「ロマンコミックス 人物日本の女性史」第18巻（1985年）。歴史漫画。\n花の乱 - NHK大河ドラマ（1994年）。応仁の乱前後の時代が描かれた。\n応仁記 - ウォーゲーム日本史第23号（2014年）。応仁の乱をテーマにしたボードゲーム付き雑誌。\n応仁の天下：混沌の乱世の幕開け - ゲームジャーナル第84号（2022年）。応仁の乱をテーマにしたボードゲーム付き雑誌。\n戦国大戦 - セガ（現・セガ・インタラクティブ）のトレーディングカードアーケードゲーム（2010年）。ver2.2『-1477 破府、六十六州の欠片へ-』（2014年）は応仁の乱を題材としている。\n\n\n== 関連項目 ==\n\n応仁記・応仁略記\n享徳の乱 - ほぼ同時期に起きた関東地方の戦乱。応仁の乱よりも長期に渉った。\n西陣織 - 応仁の乱を期に発展。\n足軽 - 主たる戦力の一つ。\n京極騒乱 - 応仁の乱の只中に発生した京極氏のお家騒動・内乱。\n第一次観音寺城の戦い\n第二次観音寺城の戦い\n第三次観音寺城の戦い\n原田城 - 東軍の拠点の1つ。\n天文法華の乱 - 天文5年（1536年）に京都で起こった宗教戦争。被害は応仁の乱以上とされている。\n京都の大火\n\n\n== 外部リンク ==\n\n應仁の亂に就て--内藤湖南（青空文庫）\n応仁の乱 コトバンク\nThe Ōnin War\u3000Visualizing 12 Years of War in Japan, 1465-78 ‐ 応仁の乱の各地戦乱地図、プリンストン大学'}]]




```python
# 結果を出力
for article in articles_overview:
    if len(article) != 0:
        article = article[0]
        print('キーワード:', article['keyword'])
        print('タイトル:', article['title'])
        print('URL:', article['url'])
        print('概要:', article['summary'])
        print('\n')
```

    キーワード: 応仁の乱
    タイトル: 応仁の乱
    URL: https://ja.wikipedia.org/wiki/%E5%BF%9C%E4%BB%81%E3%81%AE%E4%B9%B1
    概要: 応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年に及んで継続した内乱。
    室町幕府管領家の畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となり、幕府勢力が東西に分かれて争う戦乱に発展、さらに各々の領国にも争いが拡大する大乱となった。
    明応2年（1493年）の明応の政変と並んで戦国時代移行の原因とされる。
    11年に亘る戦乱は、西軍が解体されたことで収束したが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃した。
    応仁元年（1467年）に起きたことから一般に「応仁の乱」と呼ばれるが、戦が続いたことにより、応仁はわずか3年で文明へと改元された。そのため、近年では「応仁・文明の乱」（おうにん・ぶんめいのらん）と称されることもある。
    
    



```python
def generate_wiki_questions(model_name, summary_text):
    # Wikipediaの概要から質問を生成する関数
    prompt = [
        {"role": "system", "content": "You are an experienced Wikipedia writer and want to edit a specific page."},
        {"role": "system", "content": "Besides your identity as a Wikipedia writer, you have a specific focus when researching the topic."},
        {"role": "system", "content": "Now, you are chatting with an expert to get information. Ask good questions to get more useful information."},
        {"role": "system", "content": "When you have no more question to ask, say 'Thank you so much for your help!' to end the conversation."},
        {"role": "system", "content": "Please only ask one question at a time and don't ask what you have asked before."},
        {"role": "system", "content": "Your questions should be related to the topic you want to write."},
        {"role": "user", "content": f"Input summary: {summary_text}"},
        {"role": "system", "content": "Please generate three distinct questions based on the input summary."},
        {"role": "system", "content": "The questions should be formatted as:\nQuestion 1: [Your question here]\nQuestion 2: [Your question here]\nQuestion 3: [Your question here]"}
    ]

    
    # 会話を開始するためにチャットAPIを使用する
    response = client.chat.completions.create(
        model=model_name, # モデル名を指定
        messages=prompt,
        temperature=TEMPERATURE,
    )
    
    questions = response.choices[0].message.content
    
    return questions


```


```python
# 記事から生成された質問を格納するリストを初期化
all_questions = []

# 各記事の要約に対して質問を生成
for article in articles_overview:
    if len(article) != 0:
        article = article[0]
        questions = generate_wiki_questions(MODEL_NAME, article['summary'])
        all_questions.append({
            'title': article['title'],
            'questions': questions
        })
```


```python

# 生成された質問のリストを出力
for item in all_questions:
    print(f"Title: {item['title']}")
    print(f"questions: {item['questions']}")
    # for question in item['questions']:
    #     print(question)
    print('\n')  # 質問の間に空行を挿入

```

    Title: 応仁の乱
    questions: Question 1: What were the main factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period?
    
    Question 2: How did the Ōnin War impact the political landscape of Japan during the 15th century, particularly in relation to the Ashikaga shogunate and powerful daimyo families?
    
    Question 3: In what ways did the Ōnin War contribute to the transition to the Sengoku period in Japanese history, and what were the key events that marked the end of this conflict in 1477?
    
    



```python
import requests

# APIキー設定
api_key = os.getenv("BING_API_KEY")
# APIリクエストを送信
url = 'https://api.bing.microsoft.com/v7.0/search'
```


```python
all_questions
```




    [{'title': '応仁の乱',
      'questions': 'Question 1: What were the main factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period?\n\nQuestion 2: How did the Ōnin War impact the political landscape of Japan during the 15th century, particularly in relation to the Ashikaga shogunate and powerful daimyo families?\n\nQuestion 3: In what ways did the Ōnin War contribute to the transition to the Sengoku period in Japanese history, and what were the key events that marked the end of this conflict in 1477?'}]




```python
all_questions[0]['questions'].split("\n")[0].split(": ")[-1]
```




    'What were the main factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period?'




```python
all_questions[0]['questions'].split("\n")
```




    ['Question 1: What were the main factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period?',
     '',
     'Question 2: How did the Ōnin War impact the political landscape of Japan during the 15th century, particularly in relation to the Ashikaga shogunate and powerful daimyo families?',
     '',
     'Question 3: In what ways did the Ōnin War contribute to the transition to the Sengoku period in Japanese history, and what were the key events that marked the end of this conflict in 1477?']




```python
item['questions']
```




    'Question 1: What were the main factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period?\n\nQuestion 2: How did the Ōnin War impact the political landscape of Japan during the 15th century, particularly in relation to the Ashikaga shogunate and powerful daimyo families?\n\nQuestion 3: In what ways did the Ōnin War contribute to the transition to the Sengoku period in Japanese history, and what were the key events that marked the end of this conflict in 1477?'




```python
# 前はほとんど一言しか回答せず、せっかく全文検索しているメリットがないので
# 少し説明部分も抽出する形で一まとめに要約するように生成
def generate_search_content_summary(model_name, search_query, content):
    
    prompt = [
        {"role": "system", "content": f"Please extract and summarize the following sentences with keywords and the parts that explain the keywords."},
        {"role": "user", "content": f"keyword: {search_query}"},
        {"role": "user", "content": f"Sentence: {content}"},
        {"role": "user", "content": "Shortened sentences:"},
    ]
    
    response = client.chat.completions.create(
        model=model_name,
        messages=prompt,
        temperature=TEMPERATURE,
    )
    
    detailed_outline = response.choices[0].message.content
    
    return detailed_outline

```


```python
import requests
from urllib.parse import urlparse, urljoin
from bs4 import BeautifulSoup
import time

def is_scraping_allowed(url):
    """
    指定されたURLに対してスクレイピングが許可されているかを確認する関数。
    
    ステージ 1: robots.txt の確認
    ステージ 2: 利用規約およびプライバシーポリシーの確認

    Parameters
    ----------
    url : str
        チェック対象のURL。

    Returns
    -------
    bool
        スクレイピングが許可されている場合はTrue、そうでない場合はFalseを返す。
    """
    # ステージ 1: robots.txt の確認
    parsed_url = urlparse(url)
    robots_url = f"{parsed_url.scheme}://{parsed_url.netloc}/robots.txt"
    
    try:
        # robots.txt にアクセスして内容を取得
        response = requests.get(robots_url)
        if response.status_code == 200:
            print(f"Accessing robots.txt at {robots_url}")
            lines = response.text.splitlines()
            user_agent_allows = False
            for line in lines:
                line = line.lower().strip()  # 小文字に変換してトリム
                # User-agent: * のセクションを確認
                if line.startswith("user-agent: *"):
                    user_agent_allows = True
                # Disallow のパスをチェック
                if user_agent_allows and line.startswith("disallow:"):
                    disallow_path = line.split(":")[1].strip()
                    if url.startswith(f"{parsed_url.scheme}://{parsed_url.netloc}{disallow_path}"):
                        print(f"Scraping disallowed for path: {disallow_path}")
                        return False
            print("Scraping allowed according to robots.txt")
            return True
        else:
            # ステージ 2: robots.txt が存在しない場合、利用規約とプライバシーポリシーを確認
            print(f"No robots.txt found at {robots_url}, checking additional pages")
            tos_url = urljoin(f"{parsed_url.scheme}://{parsed_url.netloc}", "terms-of-service")
            privacy_url = urljoin(f"{parsed_url.scheme}://{parsed_url.netloc}", "privacy-policy")
            tos_allowed = check_additional_pages(tos_url)
            privacy_allowed = check_additional_pages(privacy_url)
            return tos_allowed and privacy_allowed
    except requests.RequestException as e:
        # 例外が発生した場合、スクレイピングが許可されていないとみなす
        print(f"Error accessing robots.txt: {e}")
        return False

def check_additional_pages(url):
    """
    指定されたURLに対してスクレイピングに関する記述があるかを確認する関数。

    Parameters
    ----------
    url : str
        チェック対象のURL。

    Returns
    -------
    bool
        スクレイピングが許可されている場合はTrue、そうでない場合はFalseを返す。
    """
    try:
        # 利用規約またはプライバシーポリシーページにアクセスして内容を取得
        response = requests.get(url)
        if response.status_code == 200:
            content = response.text.lower()
            # 特定のキーワードを含む場合はスクレイピングが禁止されていると判断
            if any(keyword in content for keyword in ["scraping", "crawl", "bot"]):
                print(f"Scraping disallowed according to content at {url}")
                return False
        return True
    except requests.RequestException as e:
        # 例外が発生した場合、ページが存在しないとみなす
        print(f"Error accessing page {url}: {e}")
        return True

def fetch_text_from_url(url_link, retries=5):
    """
    指定されたURLからテキストコンテンツを取得する関数。
    
    Parameters
    ----------
    url_link : str
        取得対象のURL。
    retries : int, optional
        リトライ回数 (default is 5)

    Returns
    -------
    str
        取得したテキストコンテンツ、またはエラーメッセージ。
    """
    try:
        response = requests.get(url_link, allow_redirects=True, timeout=10)
        if response.status_code != 200:
            if retries > 0:
                time.sleep(5)  # 5秒待機
                print(f"Retrying... attempts left: {retries}")
                return fetch_text_from_url(url_link, retries - 1)  # 再帰
            else:
                return 'Error: Failed to retrieve the content after multiple attempts'
        
        soup = BeautifulSoup(response.text, 'html.parser')
        
        paragraphs = soup.find_all('p')
        list_items = soup.find_all('li')
        
        text = ' '.join([para.get_text() for para in paragraphs + list_items])
        return text

    except requests.exceptions.TooManyRedirects:
        print("Too many redirects encountered.")
        return 'Error: Too many redirects'
    except requests.RequestException as e:
        print(f"An error occurred: {e}")
        return f'Error: {e}'



```


```python

```


```python
# 生成された質問のリストごとに検索を実施
articles_q = []

# 空白の要素を除外する
questions = all_questions[0]['questions'].split("\n")
filtered_questions = [question for question in questions if question.strip()]

for question in filtered_questions:
    search_query = generate_search_queries(MODEL_NAME, question.split(": ")[-1], "one")
    
    d_lang_key = detect_language_for_keywords(search_query)
    lang = d_lang_key[0]['language']
    
    # Wikipediaを除外する検索クエリの追加
    search_query += " -site:wikipedia.org"
    
    params = {'q': search_query, 'mkt': lang, 'count': 3}
    # params = {'q': search_query, 'mkt': lang, 'count': 1}
    headers = {'Ocp-Apim-Subscription-Key': api_key}
    r = requests.get(url, headers=headers, params=params)

    # 検索結果を取得
    results = r.json()['webPages']['value']
    # 結果を連結して回答を生成
    
    links = []
    snippets = []
    for result in results:
        snippets.append(result['snippet'])
        links.append(result['url'])
        
    url_text = ""
    i = 0
    for search_link in links:
        if is_scraping_allowed(search_link):
            ur_fetch = fetch_text_from_url(search_link)
            if ur_fetch == 'Error: Failed to retrieve the content after multiple attempts':
                # 全文取得失敗したら概要を取得
                url_text += snippets[i]
            else:
                url_text += ur_fetch
                # 3.5のみ使用時の動作
                # url_text += generate_search_content_summary(MODEL_NAME, search_query, ur_fetch[:12000])
        else:
            # 取得できなかったら概要を格納
            url_text += snippets[i]
        i += 1
    # short_ans = generate_search_content_summary(MODEL_NAME, search_query, url_text[:12000])
    short_ans = generate_search_content_summary(MODEL4o_NAME, search_query, url_text)
    
    articles_q.append({
        'questions': question,
        'answer' : short_ans,
        'links' : links,
    })
```

    Accessing robots.txt at https://www.britannica.com/robots.txt
    Scraping allowed according to robots.txt
    Accessing robots.txt at https://www.britannica.com/robots.txt
    Scraping allowed according to robots.txt
    Error accessing robots.txt: HTTPSConnectionPool(host='commons.princeton.edu', port=443): Max retries exceeded with url: /robots.txt (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x7fdc3c3eff70>: Failed to resolve 'commons.princeton.edu' ([Errno -2] Name or service not known)"))
    Accessing robots.txt at https://www.britannica.com/robots.txt
    Scraping allowed according to robots.txt
    Accessing robots.txt at https://www.britannica.com/robots.txt
    Scraping allowed according to robots.txt
    Accessing robots.txt at https://www.metmuseum.org/robots.txt
    Scraping allowed according to robots.txt
    Accessing robots.txt at https://www.britannica.com/robots.txt
    Scraping allowed according to robots.txt
    Accessing robots.txt at https://www.britannica.com/robots.txt
    Scraping allowed according to robots.txt
    Accessing robots.txt at https://kansai-odyssey.com/robots.txt
    Scraping allowed according to robots.txt



```python
links
```




    ['https://www.britannica.com/event/Onin-War',
     'https://www.britannica.com/place/Japan/The-Onin-War-1467-77',
     'https://kansai-odyssey.com/onin-war-japans-longest-war/']




```python
# 結果を出力
for article in articles_q:
    print('questions:', article['questions'])
    print('answer:', article['answer'])
    print('links:', article['links'])
    print('\n')
```

    questions: Question 1: What were the main factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period?
    answer: Sure, here are the sentences shortened with the relevant keywords:
    
    **Keywords: Factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period**
    
    1. **Ashikaga dynasty's weakness**: By 1467, the Ashikaga dynasty of shoguns in Japan had grown so weak that a succession dispute provided the trigger for a civil war.
    2. **Succession dispute**: The civil war was sparked by a succession dispute within the Shogun’s own family.
    3. **Rival samurai families**: The Onin War was fought between the families of two samurais, Yamana Sozen and Hosokawa Katsumoto, who were close to the Ashikaga Shogun.
    4. **Economic distress**: The civil war was caused by economic distress and precipitated by a dispute over the shogunal succession.
    5. **Severe famines**: Severe famines engendered rebellion nearly every autumn, and Shogun Yoshimasa issued 13 edicts for the cancellation of debts known as tokuseirei, or “acts of grace.”
    6. **Factional support**: The eastern army of the Hosokawa party had the support of both the emperor and the shogun, while the western army, assisted by the Ōuchi family, recovered its power.
    
    These points encapsulate the critical factors that led to the outbreak of the Ōnin War in 1467 during the mid-Muromachi period.
    links: ['https://www.britannica.com/event/Onin-War', 'https://www.britannica.com/place/Japan/The-Onin-War-1467-77', 'https://commons.princeton.edu/onin/']
    
    
    questions: Question 2: How did the Ōnin War impact the political landscape of Japan during the 15th century, particularly in relation to the Ashikaga shogunate and powerful daimyo families?
    answer: **Keywords and Explanations:**
    
    1. **Economic distress and succession dispute:** 
       - During the rule of Ashikaga Yoshimasa, a civil war broke out around Kyōto due to economic distress and a dispute over shogunal succession.
    
    2. **Tokuseirei ("acts of grace"):** 
       - Severe famines led to rebellion, prompting Yoshimasa to issue 13 edicts for debt cancellation known as tokuseirei.
    
    3. **Succession dispute:** 
       - Yoshimasa's lack of an heir led to a proposal for his brother to succeed, but later fathering a child caused a serious dispute over control of the Ashikaga family.
    
    4. **Fighting in Kyōto:** 
       - In 1467, fighting began between the eastern army (Hosokawa party) and the western army (Yamana faction), causing severe destruction in Kyōto.
    
    5. **Spread to provinces:** 
       - Even after the war ended in Kyōto, fighting spread to the provinces, leading to local samurai establishing themselves as daimyo during the disturbances.
    
    6. **Local samurai as daimyo:** 
       - Local samurai with village roots frequently became domain lords (daimyo) and organized armed uprisings, challenging the great shugo.
    
    7. **Self-governing regions:** 
       - In 1485, local warriors in southern Yamashiro demanded the withdrawal of Hatakeyama armies, leading to self-governance for over eight years.
    
    8. **Loss of income:** 
       - The civil aristocracy and temple complexes lost income from shōen, leading many to leave the capital and move under the protection of local daimyo.
    
    9. **Ashikaga Yoshimasa's retreat:** 
       - Yoshimasa built the Silver Pavilion (Ginkaku-ji) and lived in elegance, neglecting government matters, causing the bakufu's political power to wane.
    
    10. **Rise of Hosokawa family:** 
        - Real power shifted to the Hosokawa family (1490–1558) and then to their retainers, the Miyoshi family (1558–65), and later to the Matsunaga family (1565–68).
    
    11. **Gekokujō ("inferiors overcoming superiors"):** 
        - Independent local leaders usurped domains from their superiors, leading to the disappearance of shugo and the rise of a new type of daimyo.
    
    12. **Sengoku period:** 
        - This era of constant warfare among lords is called the Sengoku ("Warring States") period, marked by daimyo building strong military bases.
    
    13. **Daimyo autonomy:** 
        - Daimyo territories were almost free from bakufu control, with daimyo issuing their own laws and enforcing strict regulations over retainers and farmers.
    
    14. **Economic development:** 
        - Commerce and towns developed, with periodic markets and the circulation of coined money, despite confusion due to privately minted coins.
    
    15. **Guilds and towns:** 
        - Muromachi guilds protected against new merchants, and new guilds arose in castle towns, with cities like Kyōto, Nara, and harbor towns flourishing.
    
    16. **Portuguese arrival:** 
        - In 1543, Portuguese shipwrecked on Tanega, introducing musket construction to Japan, which revolutionized warfare.
    
    17. **Christianity and trade:** 
        - Jesuit missionaries like Francis Xavier arrived in 1549, using trade to propagate Christianity, with some daimyo converting for trade benefits.
    
    18. **Sakai's resistance:** 
        - The trading port of Sakai resisted daimyo domination, with its assembly maintaining soldiers and defenses, compared to free cities of Europe.
    links: ['https://www.britannica.com/place/Japan/The-Onin-War-1467-77', 'https://www.britannica.com/event/Onin-War', 'https://www.metmuseum.org/toah/ht/08/eaj.html']
    
    
    questions: Question 3: In what ways did the Ōnin War contribute to the transition to the Sengoku period in Japanese history, and what were the key events that marked the end of this conflict in 1477?
    answer: 1. **Ōnin War's Contribution to the Sengoku Period**: The Ōnin War (1467–77) marked the collapse of central authority under the Ashikaga shogunate, leading to the Age of Warring States, characterized by the rise of independent local leaders and constant warfare among daimyo.
    
    2. **Key Events Marking the End of the Ōnin War in 1477**: 
       - **Death of Key Leaders**: Both Yamana Sozen and Hosokawa Katsumoto died in 1473, but the cause of their dispute had been forgotten.
       - **Destruction and Spread of Fighting**: The war left Kyoto in ruins and spread to neighboring provinces, leading to self-governing regions, such as southern Yamashiro.
       - **Rise of Local Power**: Local samurai and domain lords (daimyo) established themselves, often usurping the power of the great shugo, fostering a new era of decentralized power.
    links: ['https://www.britannica.com/event/Onin-War', 'https://www.britannica.com/place/Japan/The-Onin-War-1467-77', 'https://kansai-odyssey.com/onin-war-japans-longest-war/']
    
    



```python
# 関連する検索結果のまとめ
related_search_results = ""
related_search_links = []
for article in articles_q:
    related_search_results += article['answer']
    for link in article['links']:
        related_search_links.append(link)

```


```python
articles_overview[0][0]['summary']
```




    '応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年に及んで継続した内乱。\n室町幕府管領家の畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となり、幕府勢力が東西に分かれて争う戦乱に発展、さらに各々の領国にも争いが拡大する大乱となった。\n明応2年（1493年）の明応の政変と並んで戦国時代移行の原因とされる。\n11年に亘る戦乱は、西軍が解体されたことで収束したが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃した。\n応仁元年（1467年）に起きたことから一般に「応仁の乱」と呼ばれるが、戦が続いたことにより、応仁はわずか3年で文明へと改元された。そのため、近年では「応仁・文明の乱」（おうにん・ぶんめいのらん）と称されることもある。'




```python
articles_overview[0][0]['content']
```




    '応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年に及んで継続した内乱。\n室町幕府管領家の畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となり、幕府勢力が東西に分かれて争う戦乱に発展、さらに各々の領国にも争いが拡大する大乱となった。\n明応2年（1493年）の明応の政変と並んで戦国時代移行の原因とされる。\n11年に亘る戦乱は、西軍が解体されたことで収束したが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃した。\n応仁元年（1467年）に起きたことから一般に「応仁の乱」と呼ばれるが、戦が続いたことにより、応仁はわずか3年で文明へと改元された。そのため、近年では「応仁・文明の乱」（おうにん・ぶんめいのらん）と称されることもある。\n\n\n== 背景 ==\n\n\n=== 足利義政の8代将軍就任 ===\n鎌倉時代後期から、名門武家・公家を始めとする旧来の支配勢力は、相次ぐ戦乱の結果、力をつけてきた国人・商人・農民などの台頭によって、その既得権益を侵食されつつあった。また、守護大名による合議制の連合政権であった室町幕府は成立当初から将軍の権力基盤は脆弱で、三管領（細川氏、斯波氏、畠山氏）など宿老の影響力が強かった。それは宿老や守護大名も例外ではなく、領国の守護代や有力家臣の強い影響を受けていた。こうした環境が、家督相続の方式が定まっていなかったことも相まってしばしば将軍家・守護大名家に後継者争いや「お家騒動」を発生させる原因になった。幕府は、4代将軍足利義持の弟で、籤引きによって選ばれた6代将軍足利義教が専制政治を敷き、守護大名を抑えつけて将軍の権力を強化したが、嘉吉元年（1441年）に赤松満祐に暗殺されてしまう。この混乱を収束させたのは管領細川持之と畠山持国であった。しかし、嘉吉2年（1442年）細川持之は隠居し翌年死去、7代将軍となった義教の嫡子である9歳の義勝も就任1年足らずで急逝した。義勝の同母弟である8歳の足利義政が、管領に就任していた畠山持国邸における衆議により次期将軍に選ばれ、文安6年（1449年）に正式に将軍職を継承した。\n\n\n=== 細川氏・山名氏の連携と、管領畠山持国の隠居 ===\n管領であった畠山持国は、足利義教に隠居させられていたが、嘉吉の乱の際に武力で家督を奪還し、義教によって家督を追われた者達を復権させ勢力を拡大した。持国には子がなかったため、弟の持富を養子に迎えていた。しかし、永享9年（1437年）に義夏（後の畠山義就）が生まれたため、文安5年（1448年）に持富を廃嫡して義夏を家督につけた。これは将軍・足利義政にも認められ、義夏は義政から偏諱を授けられている。\nそして、畠山持国、足利義政、義政の乳母今参局は一致して斯波氏家臣の争いに介入し、宝徳3年（1451年）の織田郷広の尾張守護代復帰を支援した。しかしこれは越前・遠江守護代甲斐常治の意を受けた日野重子（義政の母）の反対により頓挫した。さらに、畠山家内部でも重臣神保氏・遊佐氏は持富の廃嫡に納得せず、持国の甥で持富の子弥三郎を擁立するべきと主張した（持富は宝徳4年（1452年）に死去）。\nこのため享徳3年（1454年）4月3日畠山持国は神保国宗を誅殺した。この畠山氏の内紛に対し、細川勝元、山名宗全、そして畠山氏被官の多くが、勝元と宗全の下に逃れた畠山弥三郎・政長兄弟を支持し、8月21日に弥三郎派が持国の屋敷を襲撃した。難を逃れた畠山持国は8月28日に隠居させられ、義就は京都を追われ、足利義政は弥三郎を家督継承者と認めなくてはならなかった。一方で、弥三郎を匿った細川勝元の被官の処刑も命ぜられ、喧嘩両成敗の形も取られた。しかし山名宗全はこの命令に激怒し、処刑を命令した義政とそれを受け入れた勝元に対して反発した。足利義政は宗全追討を命じたが、細川勝元の嘆願により撤回され、宗全が但馬国に隠居することで決着した。12月6日に宗全が但馬国に下向すると、13日に義就が軍勢を率いて上洛して弥三郎は逃走。再び畠山義就が家督継承者となった。\nなお、文安4年（1447年）に勝元が宗全の養女を正室として以来、細川・山名の両氏は連携関係にあった。\n\n\n=== 管領細川勝元と畠山義就の対立 ===\n翌享徳4年3月26日（1455年4月12日）に畠山持国は死去し、畠山義就が畠山氏の家督を相続した。義就は弥三郎派の勢力を一掃するため、領国内で活発な弾圧を行った。この最中、義就は義政の上意と称して軍事行動を行ったため、義政の信任を次第に失った。さらに義就は勝元の所領である山城国木津を攻撃、細川勝元は弥三郎を擁立することで義就の追い落としを計画した。一方で山名宗全は、長禄2年（1458年）に赦免され、同年に義就と共に八幡神人討伐に参陣した頃から親義就派となっていった。長禄3年（1459年）には弥三郎が赦免され、上洛を果たしたがまもなく死去。代わって政長が勝元と弥三郎派の家臣団に擁立された。\n寛正元年（1460年）9月20日には義政によって政長の畠山氏家督が認められ、義就は追放された。義就は河内嶽山城に籠もって徹底抗戦を図ったため義政は追討軍を発し、義就を攻撃させた（嶽山城の戦い）。しかし義就は寛正4年（1463年）4月15日まで攻撃を耐え抜き、嶽山城が落城した後は紀伊国、次いで吉野へ逃れた。\n\n\n=== 足利義政の関東政策と斯波氏 ===\n一方、関東では、享徳3年（1455年）に幕府に叛旗を翻し享徳の乱を起こした鎌倉公方（後に古河公方）足利成氏を討伐するため、長禄元年（1457年）足利義政は、異母兄の足利政知を新たな鎌倉公方として関東に派遣したが、政知は鎌倉へ下向できず、長禄2年（1458年）伊豆国堀越に留まった（後の堀越公方）。足利義政は斯波義敏を始めとする成氏追討軍を派遣しようとしたが、義敏が執事の甲斐常治と内乱を起こしたため更迭、息子の松王丸（義寛）を斯波氏当主に替えた。さらに寛正2年（1461年）、足利義政は斯波氏の家督を松王丸から、足利政知の執事である渋川義鏡の子・斯波義廉に替え、堀越府の軍事力強化を企図した。しかし、渋川義鏡が扇谷上杉家の上杉持朝と対立し、その後失脚したため、足利義政は斯波義敏の復権を画策した。\n\n\n=== 足利義政と政所執事 ===\n畠山氏や斯波氏の他にも、富樫氏、小笠原氏、六角氏でもお家騒動が起こっている。幕府はこれらの調停も行ったが、対応が首尾一貫せず、守護家に分裂の火種を残した。この政策は、室町幕府政所執事であり、義政側近の伊勢貞親が、将軍権力の向上を企図して主導したものであった。さらに、寛正4年（1463年）8月、義政の母日野重子が没し、大赦が行われ、畠山義就、武衛騒動で失脚した斯波義敏ら多数の者が赦免された。\nこの前後の一貫性のない幕府・朝廷の対応を興福寺別当尋尊は「公武御成敗諸事正体無し」と批判している。しかし、この大赦には、斯波義敏の妾と伊勢貞親の妾が姉妹であることや、細川勝元への牽制などの動機があった。ところが、この伊勢貞親の政策の裏では、中央から遠ざかっていた山名宗全が斯波義廉に接近、畠山義就、伊予国や安芸国で細川勝元と対立する大内政弘とも提携、反勢力の中核となっていった。\nまた、嘉吉の乱鎮圧に功労のあった山名宗全は主謀者赤松氏の再興に反対していたが長禄2年（1458年）、勝元が宗全の勢力削減のため、長禄の変で赤松氏遺臣が功績を立てたことを根拠に赤松政則を加賀守護職に取り立てたことから両者は激しく対立した。\n後に勝元が養子で宗全の末子豊久を廃嫡したことが応仁の乱の一因となったともされる。\n\n\n=== 足利義視の還俗と義尚誕生 ===\n足利義政は29歳になったが今だ子はなく、生存している足利宗家の男子は3名のみと断絶が危惧される情勢にあった。寛正5年11月26日（1464年12月24日）、義尋は還俗し名を足利義視と改めると勝元の後見を得て今出川邸に移った。まもなく義視は、義政の正室日野富子の妹である日野良子を妻に迎えたが、これは義政と富子のとりもちによるものであった。『応仁記』一巻本には義政が「男子が生まれても僧門に入れる」と義視に約束したという記述があるが、確証はない。\n寛正6年11月23日（1465年12月11日）、義政と富子との間に足利義尚（後に義煕と改名）が誕生する。義尚は出生当時から「世嗣」として扱われていたが、義視の後継者待遇も変わらずに順調に昇進を続けており、20歳以上離れた義尚後継までの中継ぎとして扱われていた。\n富子の依頼により山名宗全が義尚の後見人とされたという『応仁記』一巻本・三巻本の記述が従来の通説であったが、近年では反証もあげられている。実際に義尚の後見人であったのは「御父」とされた義政側近の伊勢貞親であり、むしろ宗全は赤松政則を支援する義政側近と敵対していたため、義政の早期隠退と義視の将軍就任を望む立場であった。また『大乗院寺社雑事記』には義視と宗全が共同して義就を支援していた記述が見られる。更に、細川・山名の両氏が対立関係となるのは寛正6年（1465年）から文明6年（1474年）までであり、勝元と宗全の対立を乱の原因とする理解は、『応仁記』一巻本・三巻本の叙述によるものであるとの見解も提起されている。\n\n\n=== 文正の政変 ===\n\n文正元年（1466年）7月23日、足利義政は側近の伊勢貞親・季瓊真蘂らの進言で斯波氏宗家・武衛家の家督を突然、斯波義廉から取り上げ斯波義敏に与えた。さらに8月25日には越前・尾張・遠江守護職を義敏に与え、義廉を討つよう命じている。しかし勝元はこれを拒否し、宗全も義廉について戦うと表明した。貞親ら側近衆は守護大名の抵抗により窮地に追い込まれた。\n9月5日、伊勢貞親が義政に義視の誅殺を訴える事件が発生した。義政は一旦これを認めたが、9月6日に義視は居館であった今出川殿を脱出し、宗全の屋敷を経て勝元の屋敷に移った。勝元は宗全と協力して足利義視の無実を訴えた。これを受けて義政は伊勢貞親を切腹させるよう命じた。貞親は逃亡し、季瓊真蘂、斯波義敏、赤松政則も失脚して都を追われた。有力な側近を失った義政の影響力は著しく低下し14日に斯波家の家督は斯波義廉に戻された。\n\n\n== 経過 ==\n\n\n=== 御霊合戦 ===\n\n文正元年（1466年）12月、7年前の追放以来畿内近国で抵抗・逃亡を続けていた畠山義就が大軍を率いて上洛し、千本地蔵院（京都市北区）に陣取った。これまで連携していた細川勝元と山名宗全であったが、畠山氏の継承問題を巡っては立場を異にしていたため、両畠山の抗争が再び中央に持ち込まれ緊張が高まると対立するようになる。\n年が明けて1月2日（1467年2月6日）、将軍義政は正月の恒例である春日万里小路の畠山邸（政長側）への御成を取り止めて室町第に義就を招き、さらに追い討ちをかけるように山名邸の酒宴に出席して義就・宗全側を支持する姿勢を示した。1月6日には政長の管領職を罷免し、畠山邸を義就へ明け渡すよう命じた。これに対して勝元は室町第を包囲して将軍から義就追討令を得ようと企図したが、勝元夫人（宗全の娘）が事前に宗全に情報を漏らしたため、宗全・義就・斯波義廉（管領）が先手を打って室町第を占拠し、勝元側は御所巻に失敗した。\n1月18日（2月22日）、政長は自邸に火を放って上御霊神社（京都市上京区）に陣を敷き抗戦の構えを見せた。義就は天皇や上皇らも室町第に避難させて将軍とともに抱え込み、勝元・政長・京極持清の兵がこれを御所巻にした。ここに至って将軍義政は畠山氏の私闘への関与を禁じたが、宗全や山名政豊（宗全の孫）・斯波義廉・朝倉孝景（斯波氏宿老）らはこれに取り合わず義就に加勢した。義政の命に従って政長への加勢を止めた勝元は「弓矢の道」に背くものとして非難を受けた。義就側は釈迦堂から出兵して御霊社の政長軍を攻撃した（御霊合戦）。戦いは夕刻まで続いたが、政長は夜半に社に火をかけて自害を装い逃走した。勝元邸に匿われたといわれる。\n\n\n=== 大乱前夜 ===\n\n山名宗全らが室町第を占拠したことで幕府中枢から排除された格好となった細川勝元は、御霊合戦の後も没落せずなお京都に留まり続けていた。山名方は斯波義廉（管領）の管領下知状により指令を行っていたが、勝元も代々管領職を務める細川京兆家当主の立場で独自に（管領の職務である）軍勢催促状や感状の発給、軍忠状の加判などを自派の大名や国人に行った。そして四国など細川氏一族の分国からも兵を京都へ集結させるなどしたため緊迫した状態が続いた。3月5日に改元されて後の応仁元年（1467年）4月に細川方の兵が山名方の年貢米を略奪する事件が相次いで起き、足利義視が調停を試みている。また細川方の兵は宇治や淀など各地の橋を焼き、4門を固めた。\n宗全は5月20日に評定を開き、五辻通大宮東に本陣を置いた。両軍の位置関係から細川方を「東軍」、山名方を「西軍」と呼ぶ。『応仁記』によれば東軍が16万、西軍が11万以上の兵力だったというが、これは誇張と考えられる。京都に集結した諸将は北陸、信越、東海と九州の筑前、豊後、豊前が大半であった。守護分国の分布では、東軍が細川氏一族の畿内と四国に加えその近隣地域の自派の守護、西軍は山名氏の他に細川派の台頭に警戒感を強める周辺地域の勢力が参加していた。当初の東軍の主力は細川氏・畠山政長・京極持清・武田信賢に文正の政変で失脚した赤松政則・斯波義敏を加えた顔ぶれで、西軍の主力は山名氏・斯波義廉（管領）・畠山義就・一色義直・土岐成頼・大内政弘であった。\n\n\n=== 開戦と東軍の足利義視推戴 ===\n応仁元年（1467年）5月、東軍はかつての播磨守護赤松氏の一門赤松政則が山名分国の播磨国に侵攻し奪還した。また武田信賢・細川成之らが若狭国の一色氏の領地へ、斯波義敏が越前国へ侵攻した。美濃土岐氏一門の世保政康も旧領であった一色氏の伊勢国を攻撃している。\n\nそして、5月26日に京都での戦いが始まる（上京の戦い）。夜明け前、東軍は成身院光宣（興福寺衆徒）が室町第西隣の一色義直邸に近い正実坊を、武田信賢が実相院を占拠した。武田信賢・細川成之の軍が続いて一色邸を襲撃し、義直は直前に脱出したものの屋敷は焼き払われた。細川勝元は戦火から保護するという名目で室町第を押さえて将軍らを確保し、自邸（今出川邸）に本陣を置いた。勝元は匿っていた畠山政長を含む自派の諸将兵に応じるよう呼びかけた。また西軍についた幕府奉行衆の責任を追及し、6月11日には恩賞方を管轄していた飯尾為数が殺され、8月には伊勢貞藤（貞親の弟）が追放された。京都で開戦した26日、西軍は斯波義廉（管領）配下の朝倉・甲斐氏の兵が山名宗全邸南側の細川勝久邸を攻めて細川勢と激戦を展開し、東から援軍に来た京極持清を返り討ちにした。東軍の赤松政則は南下して正親町を通り、猪熊に攻め上って斯波勢を退け、細川勝久はこの隙を見て東の細川成之邸に逃げ込んだ。西軍は勝久邸を焼き払い、さらに成之邸に攻め寄せ雲の寺、百万遍の仏殿・革堂にも火を放ち成之邸を攻撃したが東軍の抵抗で勝敗は決せず、翌日両軍は引き上げた。この合戦による火災のため、京都は北の船岡山から南の二条通りまでの一帯が延焼した。将軍義政は28日に両軍に和睦を命じ、勝元の行動を非難しながら、義就には河内下向を指示し、また伊勢貞親に軍を率いて上洛させるなど乱の収束と復権に向けた動きを取っていた。\nところが6月3日に勝元の要請によって将軍の牙旗が東軍に下され、足利義視が総大将に推戴されたことで、戦乱は拡大する方向に向かっていく。東軍は軍事行動を再開し、6月8日には赤松政則が一条大宮で山名教之を破った。さらに将軍義政が降伏を勧告すると斯波義廉ら西軍諸将は動揺して自邸に引きこもったが、東軍は義廉邸も攻撃した。京都は再び兵火に巻き込まれ、南北は二条から御霊の辻まで、東西は大舎人町から室町までが炎上した。義廉・六角高頼・土岐成頼はいったんは降伏の意向を示したが、東軍に激しく抗戦する朝倉孝景（斯波氏宿老）の首級を条件とされたため断念した。\n\n\n=== 西軍大内政弘の入京と義視の逃亡 ===\n西軍は6月14日に大和国の古市胤栄、19日に紀伊国の畠山政国などの援軍が到着し始めたが、8月23日に周防国から大内政弘が伊予国の河野通春ら7か国の軍勢1万と水軍2千艘を率いて入京して勢いを回復した。同日天皇・上皇が室町第に避難し、一郭が仮の内裏とされた。一方では足利義視が伊勢貞親の復帰に危険を感じて出奔し、北畠教具を頼って伊勢国に逃亡した。この頃から西軍は管領下知状にかわって諸将の連署による下知を行い始めた。\n大内政弘は8月中に船岡山に陣取った。9月1日に攻めかかった武田勢を畠山義就・朝倉孝景が追い出し、武田勢が逃げ込んだ三宝院に火を放った。6日に将軍義政は再度義就の河内下向を命じたが、義就は従わず戦いを続けた。9月18日に京都郊外の南禅寺山でも戦いが起こり（東岩倉の戦い）、10月3日に発生した相国寺の戦いは激戦となり両軍に多くの死傷者を出したが、勝敗を決するには至らなかった。しかし、焼亡した相国寺跡には斯波義廉が陣取り、また義就は宗全邸の西に進出し、東軍は劣勢に立たされた。\n朝廷においては10月3日に後花園法皇が興福寺に山名宗全の追討を命じる治罰院宣を発したほか、12月5日（12月31日）に正親町三条公躬（公治）・葉室教忠・光忠父子・阿野季遠・清水谷実久ら西軍派とされた公家の官爵剥奪が決定された。彼らは富子の実家である日野家と対立関係にあった三条家の一族や縁者が多く、義視を支持していた公家達であった。\n\n\n=== 斯波義廉の管領解任 ===\n応仁2年（1468年）3月17日に北大路烏丸で大内政弘と毛利豊元・小早川煕平が交戦、3月21日には、稲荷山の稲荷社に陣を張って山名側の後方を撹乱・攻撃していた細川方の骨皮道賢が攻撃されて討死し、稲荷社が全焼した。5月2日に細川成之が斯波義廉邸を攻めたり、5月8日に勝元が宗全の陣を、8月1日に勝元の兵が相国寺跡の義就の陣を攻めていたが、戦闘は次第に洛外に移り、山科、鳥羽、嵯峨で両軍が交戦した。\n管領斯波義廉は西軍に属したものの、将軍義政から直ちに解任されなかった。将軍が主宰する御前沙汰なども管領不在のまま行われていた。だが、応仁2年（1468年）、幕府と敵対していた関東の古河公方足利成氏に義廉は和睦を提案し、山名宗全と畠山義就の連名の書状を送った。この理由については、義廉は幕府の関東政策の一環として斯波氏の当主に据えられたため、成氏と幕府の和睦という成果を挙げて家督と管領職の確保を狙ったと推定される。しかし、義政は独断で和睦を図った義廉を許さず、7月10日に義廉を解任して勝元を管領に任命、義廉の家督と3ヶ国守護職も取り上げられ、松王丸に替えられた。書状が出された月は2月から3月と推定され、相国寺の戦いの後に西軍有利の状況で義廉が動いたとされる。\n\n\n=== 義視の西軍入りと大内軍の優勢 ===\n応仁2年（1468年）9月22日、しばらく伊勢国に滞在していた足利義視は細川勝元（管領）や足利義政に説得されて東軍に帰陣した。帰京した義視は足利義尚派の日野勝光の排斥を義政に訴えたが、受け入れられなかった。さらに義政は閏10月16日には文正の政変で義視と対立した伊勢貞親を政務に復帰させ、11月10日には義視と親しい有馬元家を殺害するなどはっきりと義尚擁立に動き出した。勝元も義視擁立には動かず、かえって出家をすすめた。こうして義視は再度出奔して比叡山に登った。11月23日（12月19日）、西軍は比叡山に使いを出して義視を迎え入れて“新将軍”に奉った。正親町三条公躬、葉室教忠らも西幕府に祗候し、幕府の体裁が整った。以降、西幕府では有力守護による合議制の下、義視が発給する御内書によって命令が行われ、独自に官位の授与も行うようになった。\n一方で幕府では日野勝光、伊勢貞親ら義政側近の勢力が拡大し、文正の政変以前の状態に戻りつつあった。勝元には義視をあえて西軍に送り込むことで、親宗全派であった富子を幕府内で孤立させる目論見があったとも推測されている。以降勝元は西軍との戦いをほとんど行わず、対大内氏との戦闘に傾注していく。\n大内政弘の圧倒的な軍事力によって山城国は西軍によって制圧されつつあり（西岡の戦い）、京都内での戦闘は散発的なものとなり、戦場は摂津・丹波・山城に移っていった。このため東軍は反大内氏の活動を活発化させた。文明元年（1469年）には九州の大友親繁・少弐頼忠が政弘の叔父教幸を擁して西軍方の大内領に侵攻、文明2年（1470年）2月には教幸自身が反乱を起こしている。しかしいずれも留守居の陶弘護に撃退されたために政弘は軍を引くことなく、7月頃までには山城の大半が西軍の制圧下となった。\nこれ以降東西両軍の戦いは膠着状態に陥った。長引く戦乱と盗賊の跋扈によって何度も放火された京都の市街地は焼け野原と化して荒廃した。さらに上洛していた守護大名の領国にまで戦乱が拡大し、諸大名は京都での戦いに専念できなくなった。かつて守護大名達が獲得を目指していたはずの幕府権力そのものも著しく失墜したため、もはや得るものは何もなかったのである。やがて東西両軍の間には厭戦気分が漂うようになった。\n\n\n=== 各勢力の動向 ===\n東軍は将軍義政や後土御門天皇・後花園法皇を保護下に置き、将軍牙旗や治罰院宣を駆使して官軍の体裁を整え、西軍は賊軍の立場に置かれていた。しかし、正親町三条家・阿野家・葉室家などのように将軍姻戚の日野家と対立する公家の一部は義視とともに西軍に投じており、さらに西軍は「西陣南帝」と呼ばれた小倉宮後裔を担ぐなど朝廷も一時分裂状態に陥った。\n宗教勢力の動きでは蓮如率いる浄土真宗本願寺派の活動が知られ、文明5年に東軍の加賀半国守護・富樫政親の要請を受けて下間蓮崇率いる一向一揆が政親方に加担。本願寺派と敵対する浄土真宗高田派と結んだ西軍の富樫幸千代と戦い、翌文明6年に幸千代を破っている。ただこの一件が後に加賀一向一揆を勃発させる遠因となった。\n関東や九州では鎌倉公方や少弐氏らによりたびたび大規模な紛争が発生しており、大乱以前から長い戦乱状態にあった。室町幕府が直轄しない関東八ヶ国及び伊豆・甲斐（鎌倉府管轄）は享徳の乱の最中にあったが、将軍義政が送り込んだ堀越公方に対し、古河公方側が西軍と連携する動きもあった。文明7年には関東管領上杉顕定の後見人の越後守護上杉房定（実父）が西軍の能登守護畠山義統とともに東軍の畠山政長が領する越中を攻撃している。\n\n※スマートフォンなど携帯機種で閲覧の場合は横向きを推奨。\nその他\n\n一条兼良（関白・藤河ノ記の著者）\n一条教房（兼良の嫡男・土佐一条氏の祖）\n三条西実隆（実隆公記の著者）\n大乗院門跡尋尊（兼良の子・尋尊大僧正記の著者）\n大乗院門跡経覚（九条家の出・経覚私要鈔の著者）\n斎藤親基（武士・斎藤親基日記の著者）\n東常縁（武士・歌人）\n万里集九（禅僧・梅花無尽蔵の著者）\n雪舟（禅僧・水墨画家）\n正広（禅僧・歌人）\n専順（僧・歌人）\n宗祇（僧・歌人）\n\n\n=== 細川勝元と山名宗全の死去 ===\n文明3年（1471年）5月21日、斯波義廉（前管領）の宿老で西軍の主力であった朝倉孝景が、義政による越前国守護職補任を受けて東軍側に寝返った。本来越前守護職は斯波氏のものであったが、これが臣下のはずの朝倉氏に与えられ越前一国の支配権を公認された形となった、まさに下剋上である。西軍の主力の移籍により、東軍は決定的に有利となり、東軍幕府には古河公方足利成氏の追討を再開する余裕すらも生まれた。一方で西軍は8月、擁立を躊躇していた後南朝勢力の小倉宮皇子と称する人物を擁立して「新主」とした（西陣南帝）。同年に関東の幕府軍が単独で成氏を破り、成氏の本拠地古河城を陥落させたことも西軍不利に繋がり、関東政策で地位保全を図った義廉の立場は危うくなった。\n文明4年（1472年）になると、勝元と宗全の間で和議の話し合いがもたれ始めた。開戦要因の一つであった山名氏の播磨・備前・美作は赤松政則に全て奪還された上、宗全の息子達もかねてから畠山義就支援に否定的であり、山名一族の間にも厭戦感情が生まれていた。しかし、この和議は領土返還や山名氏の再侵攻を怖れた赤松政則の抵抗で失敗した。3月に勝元は猶子勝之を廃嫡して、実子で宗全の外孫に当たる聡明丸（細川政元）を擁立した後、剃髪した。5月には宗全が自殺を図って制止され、家督を嫡孫政豊に譲り隠居する事件が起きたが、桜井英治はこれを手打ちの意思を伝えるデモンストレーションであったと見ている。\n\n\n=== 足利義政の隠居と和睦交渉 ===\n12月19日（1474年1月7日）には義政が義尚に将軍職を譲って隠居した。幕府では文明3年に長らく空席だった侍所頭人（所司）に赤松政則が任ぜられ、政所の業務も文明5年になると政所頭人（執事）伊勢貞宗によって再開されるなど、幕府業務の回復に向けた動きがみられた。管領は義尚の将軍宣下に合わせて畠山政長が任じられたものの、一連の儀式が終わると辞任してしまい、再び空席になってしまったために富子の兄である公家の日野勝光が幕府の役職に就かないまま、管領の職務を代行した。一方で富子の勢力が拡大し、義政の実権は失われていった。\n文明6年（1474年）3月、義政は小河に建設した新邸に移り、室町第には富子と義尚が残された。興福寺別当尋尊は「天下公事修り、女中御計（天下の政治は全て女子である富子が計らい）、公方（義政）は大御酒、諸大名は犬笠懸、天下泰平の時の如くなり」と評している。だが、義政の大御酒が平時と異なったのは、室町第に退避していた後土御門天皇もその酒宴に加わっており、幕府のみならず朝廷の威信の低下にもつながる事態となっていた。\n文明6年4月3日（4月19日）、山名政豊と細川政元の間に和睦が成立。山名政豊は東軍の細川方と共に畠山義就、大内政弘らを攻撃した。さらにこの頃、西軍の一色義直の子義春が義政の元に出仕し、丹後一色氏も東軍に帰順した。その後も東軍は細川政元・畠山政長・赤松政則、西軍は畠山義就・大内政弘・土岐成頼を中心に惰性的な小競り合いを続けていた。また、赤松政則は和睦に反対し続けていた。\n一方、西軍の土岐成頼の重臣で従三位の奉公衆斎藤妙椿も文明6年の和睦に反対し、美濃の兵を率いて近江・京都・伊勢に出兵した。更に越前にも出兵し、同年6月に西軍の斯波義廉の重臣甲斐敏光と東軍に寝返っていた朝倉孝景を停戦させている。\n\n\n=== 終息 ===\n文明7年（1475年）2月、甲斐敏光が東軍に降伏し、遠江守護代に任命された。西幕府の管領で敏光の主君であった斯波義廉も同年11月、守護代織田敏広を連れて尾張国へ下国し、消息を絶った。しかし和平工作を行っていた日野勝光が死去したため、和睦の流れは一時頓挫した。翌文明8年（1476年）9月には、足利義政が西軍の大内政弘に「世上無為」の御内書を送り、12月には足利義視が足利義政に恭順を誓い、義政も義視の罪を不問に付すと返答し、和睦の流れが加速した。\n主戦派の畠山義就は大内政弘の降伏によって孤立することを恐れ、文明9年（1477年）9月22日に河内国に下国した。11月3日、大内政弘は東幕府に正式に降参し、9代将軍足利義尚の名で周防・長門・豊前・筑前の4か国の守護職を安堵された。大内軍が11月11日（1477年12月16日）に京から撤収し、能登守護の畠山義統や土岐成頼も京の自邸を焼き払って帰国した。義視・義材（後の10代将軍）親子は正式な赦免を受けないまま、土岐成頼や斎藤妙椿と共に美濃国に退去した。こうして西軍は解体され、9日後の11月20日、幕府によって「天下静謐」の祝宴が催され11年に及ぶ京都における大乱の幕が降ろされた。なお、西陣南帝は「諸将みな分国に帰り、京都に置き去りにされてしまわれた」とされているものの、その後の消息は不明。\nこの戦乱は延べ数十万の兵士が都に集結し、11年にも渡って戦闘が続いた。しかし惰性的に争いを続けてきた挙句、勝敗のつかないまま終わった。主だった将が戦死することもなく、戦後罪に問われる守護もなかった。西軍の最大勢力であった大内政弘も富子へ賄賂を贈り、守護職を安堵されていた。\n\n\n=== 畠山義就の赦免 ===\n西軍が消滅したとはいえ、それは単に京都での戦闘が終結したということに過ぎなかった。畠山義就は京都での退去後にも幕府の命令に従わず、河内国を占拠して政長方を駆逐し、続いて大和国に侵攻した。さらに義就は政長が守護を務めていた山城国に侵攻した。文明14年（1482年）末から文明15年（1483年）にかけては義就が宇治以南の南山城を占拠し、幕府の命令が届かない状態となった。将軍義尚や富子は政長を見限って義就を赦免しようとしたが、義政の反対で中止された。ついに文明16年（1484年）には政長の守護職を解き、幕府の直轄（御料国）としたが、戦乱はなおも続いた。\n文明17年（1485年）7月、義就方の斎藤彦次郎が政長方に寝返ったことにより、義就方と政長方の大軍が対峙することになった。しかし山城国の国人が団結し、撤退しなければ攻撃すると両軍に通達し、義就・政長らは山城国より撤退した。以降、国人たちは山城国一揆を組織し、一種の自治的な政権をつくることとなる。一方で義就は山城国より撤退したことが評価され、文明18年（1486年）3月に義政と義尚から正式に赦免され、応仁の乱の戦後処理はここに完了した。\n\n\n== 戦乱の影響 ==\n応仁の乱は幕府権力が崩壊した戦国時代の始まりであるとの説が通説であったが、近年では幕府の権威は明応の政変頃まで一応保たれていたという見解もあり、明応の政変以降を戦国時代の始まりととらえる説もある。とはいえ、応仁の乱以降身分や社会の流動化が加速されたことは間違いない。\n東洋史学者の内藤湖南は講演『応仁の乱に就て』において、応仁の乱前後を「最も肝腎な時代」であると指摘し、「大体今日の日本を知る爲に日本の歴史を研究するには、古代の歴史を研究する必要は殆どありませぬ、応仁の乱以後の歴史を知つて居つたらそれで沢山です」と発言し、古代史学者との間に論争を巻き起こした。なお後述するように歴史資料が失われたことで、応仁の乱以前には不明な点も多い。\n\n\n=== 幕府・守護権力の変化 ===\n応仁の乱により、多賀高忠、浦上則宗、斎藤妙椿、尼子清定など、守護家に迫る勢力を有する国人が台頭した。また、東西両軍は味方を得るために、それまでの家格を無視した叙任を行った。西軍は一介の国人であった越智家栄を大和守護に任命し、東軍は西軍の有力武将だったが守護代でもなかった朝倉孝景を越前守護につけた。\n文明7年、能登守護畠山義統と越後守護上杉房定が政長の分国越中を侵略した際には、足利義政が「諸国の御沙汰は毎事力法量（諸国の沙汰は力次第である）」と述べ、守護が他国を侵略することも是認された。このため室町幕府の家格秩序は崩壊し、身分秩序が流動化することになった。また長期にわたる京都での軍事活動により、守護の財政は逼迫した。権威と財政を失った守護は、国人や家臣団に対する支配力を著しく低下させた。国人や家臣は守護の影響を排除して自らの地盤を固め、領主化していった。\nそれまで在京が原則であった守護は自らの領国を守るため下国し、守護代に任せていた領国経営を自らの権威により行おうとした。これにより守護は幕府の統制を離れ、幕府は段銭などの徴収がままならなくなった。いくつかの守護は領主化を強化することで戦国大名へと成長することが出来たが、既に乱の最中に守護代や家臣に権力を奪われた者もおり、没落した守護も多かった。この従来の家格秩序を破る風潮は下克上と呼ばれ、戦国時代を象徴する言葉となる。\nまた、守護在京制の崩壊により、文明18年（1486年）には京都に残る守護が摂津・丹波を基盤とする細川氏一門のみとなった。守護の協力を得られなくなった幕府は、将軍近臣の奉公衆や奉行衆による運営を余儀なくされ、畿内政権としての道を歩み始めた。その一方で、細川勝元が幕府を西軍方に占拠されていた時に始めた、細川京兆家当主としての軍勢催促状などの軍事決裁行為が管領復帰後も継続され、勝元没後に管領となった畠山政長も義就との戦いのためにほとんど在京しなかったために、勝元の子政元が細川政国の後見を受けて同様の措置をもって幕府の軍事行動を指揮したため、細川京兆家が本来管領が有していた幕府の軍事的権限を行使するようになった。やがて細川氏と幕府の利害が対立し、明応の政変とその後の京兆専制を招くことになる。\n\n\n=== 公家の没落 ===\n領主化を推進する守護や国人によって一円知行化が進められ、公家や寺社の荘園は横領された。さらに幕府の権威低下により、遠国など幕府の権力が届かない地域の荘園・国衙領支配は絶望的になり、荘園制度の崩壊が加速した。収入を断たれた公家は没落し、朝廷行事や官位昇進への興味も失った。甘露寺親長は日記に「高官無益なり」と書き記し、文明5年には顕官である近衛大将の希望者が現れないという事態が発生している。前関白一条教房のように京都を去る公家や、町広光のように家を意図的に断絶させる公家まで現れた。また、西軍について失脚した西川房任の子孫が細川高国に仕えて薬師寺国長の寄子に付けられるなど、生活が立ち行かなくなって公家身分を棄てる例もあった。更に朝廷収入も激減し、即位礼や大喪の礼などの儀式を行うことも困難となった。このため戦国期には献金による売官が行われるようになった。これは京都文化が地方に伝播する一因ともなった。\n\n\n=== 京都の被害 ===\n文明2年頃には戦火で京都の寺社や公家・武家邸の大半が消失し、罹災を免れたのは土御門内裏などわずかであった。このため類聚国史（一部）など京都にあった歴史的資料の多くが焼失・散逸し、これ以前の歴史研究に影響を及ぼした。\n京都七口関は両軍の争奪戦となり、物資の流入も停滞した。さらに足軽の放火・略奪が追い打ちをかけ、京都の大半の人々は大いに困窮した。また文明5年には疫病が流行し、宗全や勝元も命を落とした。\nしかし、義政はこれを顧みず日夜酒宴に明け暮れ（ただし、これは将軍御所に退避した天皇に対する饗応の意味もある）、小河邸や東山山荘を造営した。また富子は困窮した東西軍の守護に金銭を貸し付けるほか、米の投機を行って大いに利益を上げた。\n寺社、公家、武家屋敷があった上京が焼け、商工業者が居住していた下京が焼け残ったことは、その後の京都の商業勃興をもたらした。\n\n\n=== 京都の復興 ===\n応仁の乱によって京都を追われた公家や民衆は京都周辺の山科や宇治、大津、奈良、堺といった周辺都市や地方の所領などに疎開していった。応仁の乱後の文明11年（1479年）に室町殿や内裏の造営が開始されたが、都市の荒廃による環境悪化によって疫病や火災、盗賊、一揆などの発生が頻発したこと、加えて在京していた守護大名やその家臣達（都市消費者として一定の役割を果たしていた）が領国の政情不安のために帰国したまま帰ってこなかったこともあり、京都の再建は順調とは言えなかった。また、こうした災害を理由とした改元（長享・延徳・明応）が相次いだ。\n将軍義政は、義教の死後中断していた勘合貿易を宝徳3年（1451年）に復活させた。勘合貿易の復活や側近の守護大名及び幕府官僚の財政再建によって、応仁の乱前の幕府財政は比較的安定してはいた。だが、義政は幕府財政を幕府の権威回復や民衆の救済にではなく、趣味の建築や庭園に費やした。結果、応仁の乱後の京都の復興は大幅に遅れることとなった。\n一方で、町衆主導によって行われたと評価されてきた明応9年（1500年）の祇園祭の再興も本来祇園祭が疫病平癒の祭りであったことを考えると、逆に当時の社会不安の反映が祇園祭再興を促したという側面も考えられる。また、当時町衆における法華宗の受容も、社会不安からくる信仰心の高まりと関連づけられる。\nそれでも明応7年（1498年）頃より京都の住民に対する地子銭徴収が次第に増加していったこと、永正5年（1508年）以後の酒屋役徴収の強化命令が幕府から出されている事からこの時期に京都の人口回復が軌道に乗り出したと考えられ、明応9年の祇園祭の前後数年間が京都の本格的な復興期と考えられている。\n\n\n=== 戦術の変化 ===\n応仁の乱の戦いで特徴的とされるものは、正規の武士身分ではない足軽の活躍である。それまでは騎乗の権利の有する正規の武士が、少数の従卒を率いる小グループ同士の戦いであり、戦いの進行も名乗りを上げた後、騎射、馬上で薙刀などを使う打物戦、最後に下馬しての徒戦という順に進んでた。\n応仁の乱は大規模な戦闘が続いたことで兵力不足に悩んだ両軍は、兵站や土木作業に従事する足軽を戦力に加えた。足軽は技量が低い者も多く、それまではタブーであった馬への攻撃も行われた。主力武器も個人戦向けの薙刀から、集団戦に適した槍へと移行した。\n東軍の足軽大将骨皮道賢や西軍の御厨子某は、後方攪乱として足軽によるゲリラ戦を行って名を上げるなど散兵も活用された。\n足軽は盗賊などの無法者を多く含んでおり、高い自立性を持っていた。彼らは異形の装いをし、市街の放火や略奪を頻繁に行った。このため一条兼良は『樵談治要』において「洛中洛外の諸社諸寺五山十刹公家門跡の滅亡は彼らが所行なり」と非難している。一方で東寺などの権門寺社も自衛のために足軽を雇用することもあった。\n\n\n== 後世の評価と研究 ==\n\n\n=== 拡大の要因 ===\n乱のきっかけは畠山義就を山名宗全が支援したことであるが、何故ここまで乱の規模が拡大し、長期間継続したのかという問題には様々な解釈が建てられている。\n多くの大名には陣営を積極的に選ぶ理由はほとんど無かった。富子は義視が西軍に逃亡した後も土御門内裏が炎上しないように西軍の大内政弘と連絡を取り合っているなど、将軍継嗣の問題だけでは説明がつかないという見方もある。永原慶二は幕政の中心人物である勝元と宗全が争ったため、結果的に幕政に関与していた諸大名は戦わざるを得なくなったとしており、戦い自体にはさしたる必然性もなく、戦意がない合戦が生み出されたとしている。\n当時の人々も理解できなかったらしく、尋尊は「いくら頭をひねっても応仁・文明の大乱が起こった原因がわからない」と「尋尊大僧正記」に記している。\n\n\n=== 軍記による描写 ===\n応仁の乱が描かれた代表的な軍記物としては、『応仁記』『後太平記』『瓦林正頼記』などがある。特に、著名な軍記物語である『応仁記』は、細かい描写がなされて乱の研究に欠かせない史料であるが、儒教的色彩が濃く、幾つかの誤りが指摘されるようになった。実子・足利義尚の将軍職擁立を切望する日野富子が山名宗全に依頼し、足利義視の将軍職就任を阻止しようと暗躍したという説は誤りであるとされ、富子が乱の元凶であったとする説を現在にまで流布させる要因となった。\n\n\n== 各地の戦乱 ==\n\n\n=== 摂津・河内・和泉・山城 ===\n摂津・河内・和泉（摂河泉と呼ばれる）3ヶ国のうち摂津・和泉は細川氏が、河内は畠山氏が守護を務めていた。しかし、畠山氏がお家騒動で混乱し、応仁の乱で大内政弘が西上して京都の戦闘が各地に及ぶと、近郊の摂河泉は東西両軍の衝突地域となっていった。また、山城国は畠山氏の領国であるが、細川勝元が畠山持国への対抗から山城国人を被官に加え、畠山持国の弱体化を目論みお家騒動を煽った影響で山城国は義就と政長どちらに付くかで分裂した。\n畠山義就は乱直前の足利幕府への工作で守護職を取り戻し、御霊合戦で畠山政長を破り立場を固めた。ところが、政長を援助していた細川勝元が諸国の軍勢を動員すると、幕府から守護職を取り上げられ政長に替えられ、再び地位を失うと義就は実力行使で領国奪取に動いた。一方、大内軍は上洛して西軍の主力として京都で東軍と戦っていたが、文明元年4月に義就が山城国西岡を攻めて陣取っていた西軍を丹波国へ追い落とし（西岡の戦い）、山城勝竜寺城へ入って摂津・丹波付近を伺うようになると、大内軍も7月に摂津国へ侵攻して諸城を落とし、摂津の殆どを制圧した。しかし、池田城だけは城主の抵抗で持ちこたえ、10月に山名宗全の次男の山名是豊と赤松政則が東軍の援軍として大内軍を撃破して兵庫を奪還したため、大内政弘は池田城の包囲を解いて東軍迎撃に向かった。これに対し、是豊は摂津神呪寺に着陣して大内軍と戦い、その後は東進して摂津と山城の国境の山崎に布陣した。\n文明2年1月から4月にかけて山崎の是豊と勝竜寺城の義就が交戦したが決着は着かず、5月に東軍の裏工作で摂津国に留まっていた大内政弘の家臣仁保弘有が寝返り、直後に茨木城と椋橋城が東軍に奪回され反撃の契機となった。一方、大内政弘は南山城の木津川流域を攻撃目標として7月に八幡へ進出して木津を除く南山城を制圧した。だが、木津に拠点を構える東軍の抵抗は激しく、大内軍は木津を奪えないまま下狛（精華町）に待機して一進一退の状況を続けていった。義就は8月に山城国から大和国を経て河内国へ侵攻、若江城と誉田城を包囲したが落とせず撤退、山名是豊は領国の備後で西軍が蜂起したため12月に下向していった。山城国は山名是豊が東幕府から守護に任じられていたが、大内軍による南山城の占拠や是豊が備後国への撤退後は義就が実力で山城を支配することになり、守護でないにもかかわらず義就は山城国を実質上占領下に置いた。\n文明3年6月、大内軍と畠山軍が合流して摂津・和泉に侵入したが、敵の反撃で失敗、以後畿内で大きな戦闘はほとんど行われず、文明4年10月に木津から出陣した東軍は大内軍の反撃で退散、文明7年4月に大内軍が木津へ攻撃して失敗したことが挙げられる程度であった。文明8年に政長は家臣の遊佐長直を河内国に下向させて若江城に赴任させたが、義就は翌文明9年9月に河内へ向かい、9月から10月にかけて若江城を始めとする河内の諸城を陥落させ長直を追放、河内を制圧した（若江城の戦い）。大内軍も呼応して木津を落としたが、大内政弘は幕府と和睦して11月に帰国したため、木津と摂津は東軍の手に戻された。以後、南山城は政長を始めとする幕府が領有したが、河内は守護ではない義就が占拠した状態が続いていくことになる。\n\n\n=== 大和 ===\n大和国も畠山持国の影響力が強かったため、大和国人もお家騒動で互いに敵対していった。義就に就いた国人は越智家栄・古市胤栄で、政長には筒井順永・成身院光宣・十市遠清・箸尾為国らが味方した。光宣は乱勃発直後から政長に仕え、御霊合戦後に政長を勝元の屋敷へ手引きして、文明元年に亡くなるまで東軍に属していた。古市胤栄は義就に手助けすべく応仁元年6月に上洛したが、他の国人衆は表立って活動は行わなかった。\n事態が動いたのは文明2年に大内軍が摂津国から南山城へ南下した時で、山城国と大和国を結ぶ重要拠点の木津を大内軍が攻めてきたため、筒井順永は木津防衛に向かい大内軍の進出を阻止した。一方、越智家栄は義就の河内侵攻に参加、古市胤栄は下狛の大内軍陣地に合流して順永と交戦、文明3年になると十市遠清も東軍方として動き、1月に近江の東軍を助けて西軍の六角高頼軍を撃破、6月に順永・遠清・箸尾為国が畠山軍の河内侵攻を阻止するなど大和国人の殆どが乱に参戦するようになった。\n文明4年10月に順永は下狛の大内軍に夜襲を仕掛けたが逆襲に遭い敗走、文明5年の和睦でも戦乱は止まず、文明6年になると大和国人衆の紛争が続出して戦乱は大和に拡大していった。文明7年4月に大内軍の木津攻撃を順永が撃退、5月に大和春日社頭で順永・遠清・為国ら東軍と家栄・胤栄ら西軍が衝突して東軍が勝利、古市胤栄は敗北の責任を取り隠居、弟の澄胤に家督を譲った。また、文明8年に筒井順永が亡くなり嫡男の順尊が後を継いだ。\n文明9年に義就が河内国に侵攻・制圧すると大内軍も木津を攻撃し、木津を守る順尊ら政長派は木津を放棄、本拠地も失い没落したため、戦乱の末に大和国は越智家栄・古市澄胤ら義就派が勝利して大和は義就の手に入った。大和国は興福寺が支配していたが、大乱に伴う分裂で国人衆の台頭を抑えられず権威が下降した。興福寺別当の尋尊は日記で戦闘を詳細に書き記す一方で、混乱を収められない無力さを嘆いている。以後、没落した政長派は潜伏して遊撃兵として義就派への抵抗を続け、大和は義就派と政長派が抗争を繰り返していった。\n\n\n=== 近江・美濃 ===\n近江国は京極氏と六角氏それぞれが治めていたが、六角氏も幕府の介入でお家騒動が悪化・分裂したため京極持清が東幕府の支援を得て近江の六角高頼を攻撃、高頼は美濃国の斎藤妙椿の後ろ盾で対抗していった。京極持清・勝秀父子は高頼の従兄の六角政堯と共に高頼の居城である近江観音寺城に度々攻め入り、高頼も応戦した。美濃国では守護の土岐成頼は西軍に加わるため上洛、守護代の斎藤利藤は幼いため叔父の斎藤妙椿が後見役として実質的に美濃を治めていたが、西美濃の国人長江氏・富島氏は京極氏と組んで妙椿に反乱を起こした。\n美濃国の内乱は応仁2年までに妙椿に鎮圧されたが、近江国は決着が着かず一進一退、観音寺城が東軍に奪われては西軍に奪回されることが繰り返されていった。しかし、応仁2年に勝秀が死去、続いて文明2年に持清も亡くなり京極氏はお家騒動で2つに割れて弱体化（京極騒乱）、勝秀の弟政光と家臣の多賀清直・宗直父子は勝秀の遺児乙童子丸を擁立して西軍に寝返り、政光の弟政経と多賀高忠は乙童子丸の弟孫童子丸を擁立して争った。文明3年に政堯が高頼に討ち取られると戦況は西軍に傾き、文明3年と4年に妙椿が高頼に援軍を派遣して東軍を圧迫する。文明5年3月に宗全が亡くなると、妙椿は上洛して宗全に代わる西軍の指導者に成り上がった。\n追い詰められた東軍は、信濃国の小笠原家長・木曾家豊に美濃の背後を突くよう要請、合わせて富島氏の再起を促し挟撃を図った。妙椿は直ちに反乱を押さえ伊勢国に出陣して東軍を牽制し、11月に出陣した小笠原家長らに東美濃を占拠されるという痛手を被ったが、文明7年1月に妙椿は信濃勢に勝利してそれ以上の侵略を阻止した。一方、京極氏は文明3年に孫童子丸が、4年に政光が没して政経が当主となったが、乙童子丸・清直父子が北近江、高頼が南近江を確保していたため東軍は劣勢となった。\nそして、文明7年10月に近江国で決戦となり、妙椿の援軍と合流した高頼が勝利を収め、近江における戦乱は終結した。幕府も乙童子丸・清直父子と高頼及び成頼・妙椿らと文明10年（1478年）に和睦してそれぞれの支配を認めた。しかし、京極騒乱は収まらず政経は抵抗を続け、幕府も後に態度を翻して近江出兵を強行したり（長享・延徳の乱）、乙童子丸から家督を取り上げ政経に与えたりしていた。美濃国でも妙椿没後に実権を握った甥の妙純と利藤が争ったり（文明美濃の乱）、成頼の後継者を巡り内乱が発生したため（船田合戦）、近江と美濃の戦乱はなおも続いていくことになる。\n\n\n=== 越前・尾張・遠江 ===\n越前・尾張・遠江3ヶ国は斯波氏領国であるが、畠山氏と同じくお家騒動と家臣団の内乱で戦争状態となっていた。義敏は乱直前に3ヶ国守護に復権したが、文正の政変で守護職を失い義廉が守護に戻った状態で乱が勃発、義敏は越前国に入り義廉派と交戦、義廉は京都で家臣の朝倉孝景・甲斐敏光らと共に東軍と戦っていた。特に朝倉孝景の活躍は目覚しく、御霊合戦では義就に加勢して政長軍を破り、一条大宮の戦いでも戦果を挙げて東軍から討伐対象に挙げられていた程であった。\nしかし、朝倉孝景に対して東軍が応仁2年から内応工作を始めると、孝景は閏10月に義敏征伐を口実に越前国に下る一方で東軍と裏交渉を行い、文明3年5月21日に孝景の越前守護職任命を記した足利義政と細川勝元の書状が届き、孝景は公然と東軍に寝返った。これにより朝倉孝景は斯波義敏と同陣営に属することになるが、両者はかつて長禄合戦で敵対していたため、共同戦線を張れないことを察した足利義政は義敏に中立を命じたため、義敏の家臣が孝景に味方しても義敏本人は合戦に参加しなかった。また、応仁2年に斯波義廉は関東との秘密交渉の発覚で足利義政から管領と守護職を取り上げられ（西幕府では存続）、細川勝元と義敏の息子松王丸がそれぞれ管領と守護職に就任した。甲斐敏光は義廉の陣営に留まっていたが、孝景の寝返りを知ると越前へ下向した。\n越前では朝倉孝景と甲斐敏光が中心となり合戦を繰り広げていったが、東幕府の支持を得た孝景が有利であり、文明4年8月に甲斐敏光の本拠地である府中（越前市）を落として甲斐敏光を加賀へ追い落とし、残党も翌文明5年8月の合戦で討ち取った。甲斐敏光は挽回を図り文明6年閏5月に富樫幸千代の援助で再度越前に攻め入るが、朝倉軍に連敗を続けた末に斎藤妙椿の斡旋で孝景と和睦、越前奪還を諦めた。\n朝倉孝景の越前統一は間近に迫ったが、文明7年4月に孝景の急成長に危機感を抱いた義敏が大野郡土橋城に籠城して国人二宮氏と結託、孝景は義政から義敏の保護を命じられていたため迂闊に土橋城を攻撃出来ず、大野郡の占拠は長期間に亘った。7月に孝景は二宮氏を土橋城外に誘き出して討ち取り、11月に土橋城の攻撃を開始したため、義敏は観念して12月に降伏、孝景の処置で京都に送り返され越前は孝景に平定された。\n甲斐敏光は文明7年2月に松王丸（元服して義良と改名）と共に上洛して足利義政から遠江守護代に命じられ下向、朝倉孝景に続いて甲斐敏光にも見捨てられた斯波義廉は11月に残された領国・尾張に向かったが、尾張でも内乱が発生、文明10年に幕府から反逆者と指名されたのを最後に消息を絶った。遠江では駿河守護今川義忠が東軍の命令を受けて文明5年から遠江へ侵攻していたが、文明7年に甲斐敏光が東軍から守護代に任命されると大義名分を失い、文明8年に今川義忠が戦死すると今川氏は後継者に嫡男龍王丸（後の今川氏親）と従弟の小鹿範満が擁立されお家騒動が発生、遠江侵攻は中断された。\n斯波義良は応仁の乱終結後は越前の奪還を図り、文明11年（1479年）に甲斐敏光と二宮氏などを連れて越前に攻め入った。文明13年（1481年）に孝景は亡くなったが、後を継いだ息子氏景は斯波軍を越前から追い出し完全平定を果たした。義良も越前奪回を諦め文明15年（1483年）に尾張へ下向、甲斐敏光も朝倉氏景と和睦して越前は朝倉氏、遠江は甲斐氏、尾張は織田氏がそれぞれ守護代として受け持つことを取り決めた。かくして越前は朝倉氏が実質的に領有を果たし、斯波氏と甲斐氏は尾張・遠江を拠点としたが、やがて今川氏親と織田氏の勢いに押されていった。\n\n\n=== 播磨・備前・美作 ===\n播磨・備前・美作は元は赤松氏領だった所を山名宗全・山名教之・山名政清ら山名一族が嘉吉の乱で奪い取った経緯があり、再興を目指す赤松の遺臣達にとって山名氏との衝突は避けられなかった。長禄の変で赤松郎党が手柄を立てたことにより、赤松政則は細川勝元の支援で加賀半国守護に就任して復権の足掛かりを築き、赤松政則は家臣の浦上則宗と共に義政の警固や屋敷建造、土一揆鎮圧などに努め義政の側近として重用された。宗全からは敵視され文正の政変で失脚したが程無く復帰、応仁の乱では在京して則宗と共に西軍と戦った。\n播磨3ヶ国では宗全を始めとする山名一族は軍勢を引き連れて上洛したため、好機と捉えた宇野政秀ら赤松氏家臣団は3ヶ国の奪還に動き出した。乱勃発直後の応仁元年5月に宇野政秀は播磨に下向して赤松氏遺臣の蜂起を促し、播磨を手に入れると備前・美作にも侵攻し備前も奪回したが、美作は守護代の抵抗が強く一度敗退、完全平定まで3年後の文明2年までかかった。この間、宇野政秀は文明元年に摂津で山名是豊と合流して池田城の救援に赴き大内軍を撃破、兵庫を奪還している。また、乱における活躍で赤松政則は東軍から3ヶ国の守護に任じられ、赤松氏の再興に大きく前進した。\n文明6年に細川氏と山名氏は単独で和睦を結び戦争から離脱した。赤松政則は和睦に反対したが、文明9年の終戦で3ヶ国守護と侍所頭人の地位を保証され赤松氏の再興を果たし、側近の浦上則宗も侍所所司代として赤松氏の重臣に成り上がった。しかし、山名氏は和睦で失った3ヶ国の奪還を狙い、宗全の後を継いだ山名政豊は播磨を伺い、赤松政則も山名氏領国の不満分子を嗾けて反乱を起こさせたため、両者は終結後も3ヶ国を巡り争奪戦を繰り広げていった。\n\n\n=== 備後・安芸 ===\n備後は宗全の次男山名是豊が治めていたが、宗全と不仲であった所を勝元に籠絡され、山名氏の大半が西軍に属したのと異なり唯一東軍に与した。安芸国は大内氏と武田氏の対立の場となっていて、安芸国人の殆どを勢力下に収める大内氏に対し、武田氏は大内氏に危機感を抱く細川氏の支援で対抗した。文安4年に安芸国で最初の衝突が発生、これ以後は大内氏が度々安芸に侵攻しては勝元が武田氏と反大内の国人を支援して侵略を阻止していった。伊予国で大内氏が河野氏を支援したことも勝元が大内氏と対立する原因となった。\n乱勃発で大内政弘は宗全の要請で領国周防から出陣、応仁元年7月20日に兵庫に上陸して8月23日に上洛、西軍と合流して東軍の脅威となった。対する武田信賢・国信兄弟と毛利豊元・吉川経基・小早川煕平ら反大内の安芸国人は東軍に加わり、是豊も上洛して東軍と合流した。上洛せず安芸・備後に留まった国人勢力も二分されそれぞれ争ったが、備後は宗全の影響力が健在だったため東軍が不利で、応仁2年11月に是豊が一時帰国しなければならない程であった。文明元年に是豊は再び上洛、その途上で摂津の大内軍を破り山崎に布陣して翌文明2年西軍と交戦、備後が西軍の加勢でまたもや劣勢になったため12月に帰国した。一方の武田信賢らは京都に留まり西軍と戦った。\n文明3年になると信賢と国信の弟で安芸の留守を守っていた武田元綱が西軍の工作で反乱を起こし、毛利豊元も大内氏に誘われて安芸に帰国すると西軍に寝返り、安芸・備後は西軍有利に傾いた。東軍は国人衆に忠誠を誓わせ寝返り防止に努め、山名是豊も備後で転戦して形勢を立て直そうとしたが、文明5年から文明7年の2年間西軍の小早川弘景ら安芸・備後国人衆が東軍方の小早川敬平が籠城する高山城を包囲したにもかかわらず救援に来なかったことから人望を失い、備後から追放され消息を絶った。文明7年4月23日に安芸・備後の東西両軍は和睦を結び、中国地方の戦乱は終息に向かった。\n戦後備後は山名是豊の甥（弟とも）に当たる山名政豊が領有することになり、残党は政豊に討伐された。安芸は武田氏を始め国人が割拠する状態に置かれ、武田元綱は文明13年に信賢の後を継いだ武田国信と和睦、安芸の国人領主として兄から独立し大内氏と友好関係を結んだ。他の国人衆も大内氏との対立を解消し安芸は平穏になったが、戦乱を通して大内氏の影響力は増大、備後で山名政豊と国人が対立して支配が揺らいだため、大内氏と新たに台頭した尼子経久が国人衆を巻き込み衝突していった。\n\n\n== 脚注 ==\n\n\n=== 注釈 ===\n\n\n=== 出典 ===\n\n\n== 参考文献 ==\n\n\n=== 中央関係 ===\n榊山潤、1960年、『応仁の大乱』、河出書房新社\n永島福太郎、1968年、『応仁の乱』、至文堂\n鈴木良一、1973年、『応仁の乱』、岩波新書 ISBN 4004131006\n永原慶二、1979、『下克上の時代』、中公文庫〈日本の歴史10〉 ISBN 978-4122000780\n安田元久編、1985年、『鎌倉・室町人名事典』、新人物往来社 ISBN 4404013027\n阿部猛・西村圭子編、1987年、『戦国人名事典』、新人物往来社 ISBN 4-404-01412-0\n笠原一男、1991年、『室町幕府と応仁の乱』、木耳社\n小川信、1994、『山名宗全と細川勝元』、新人物往来社 ISBN 4404021062\n宮本義己、1994年、『応仁の乱に生きる』上・下、日本放送出版協会\n辻川達雄、1996、『蓮如と七人の息子』、誠文堂新光社 ISBN 4-416-89620-4\n森茂暁、1997、『闇の歴史 後南朝 後醍醐流の抵抗と終焉』、角川選書\n桜井英治、2001、『室町人の精神』、講談社学術文庫〈日本の歴史12〉 ISBN 978-4062689120\n川岡勉、2002年、『室町幕府と守護権力』、吉川弘文館 ISBN 4-642-02814-5\nドナルド・キーン、2003、『足利義政 - 日本美の発見』、中央公論新社 ISBN 978-4120033575\n早島大祐、2006年、『首都の経済と室町幕府』、吉川弘文館 ISBN 4642028587\n石田晴男、2008、『応仁・文明の乱』、吉川弘文館〈戦争の日本史9〉 ISBN 978-4-642-06319-7\n福島克彦、2009、『畿内・近国の戦国合戦』、吉川弘文館〈戦争の日本史11〉\n吉田賢司、2010、『室町幕府軍制の構造と展開』、吉川弘文館 ISBN 978-4642028899\n木下昌規、2014年、『戦国期足利将軍家の権力構造』、岩田書院 ISBN 978-4-87294-875-2\n呉座勇一、2016、『応仁の乱 戦国時代を生んだ大乱』、中公新書 ISBN 978-4-12-102401-5\n家永遵嗣「足利義視と文正元年の政変」『学習院大学文学部研究年報』61号、2014年。 \n日本史史料研究会（監修） 著「足利義政（執筆・下川雅弘）、足利義視（執筆・西島太郎）、足利義尚（執筆・木下聡）、足利義稙（執筆・西島太郎）」、平野明夫 編『室町幕府全将軍・管領列伝』星海社、2018年。ISBN 978-4065136126。 \n\n\n=== 地方関係 ===\n岐阜県編、1969、『岐阜県史 通史編 中世』、岐阜県\n兵庫県編、1978、『兵庫県史 第三巻』、兵庫県\n大阪府史編集専門委員会編、1981、『大阪府史第4巻 中世編 2』、大阪府\n広島県編、1984、『広島県史 中世 通史』、広島県\n戦国合戦史研究会、1988年、『戦国合戦大事典 五』、新人物往来社\n岡山県編、1991、『岡山県史 第五巻 中世II』、岡山県\n朝倉弘、1993、『大和武士』、名著出版〈奈良県史11〉\n福井県編、1994、『福井県史 通史編2 中世』、福井県\n静岡県編、1997、『静岡県史 通史編2 中世』、静岡県\n宮島敬一、2008、『浅井氏三代』、吉川弘文館〈人物叢書〉\n\n\n== 関連作品 ==\n日野富子 - 世界文化社「ロマンコミックス 人物日本の女性史」第18巻（1985年）。歴史漫画。\n花の乱 - NHK大河ドラマ（1994年）。応仁の乱前後の時代が描かれた。\n応仁記 - ウォーゲーム日本史第23号（2014年）。応仁の乱をテーマにしたボードゲーム付き雑誌。\n応仁の天下：混沌の乱世の幕開け - ゲームジャーナル第84号（2022年）。応仁の乱をテーマにしたボードゲーム付き雑誌。\n戦国大戦 - セガ（現・セガ・インタラクティブ）のトレーディングカードアーケードゲーム（2010年）。ver2.2『-1477 破府、六十六州の欠片へ-』（2014年）は応仁の乱を題材としている。\n\n\n== 関連項目 ==\n\n応仁記・応仁略記\n享徳の乱 - ほぼ同時期に起きた関東地方の戦乱。応仁の乱よりも長期に渉った。\n西陣織 - 応仁の乱を期に発展。\n足軽 - 主たる戦力の一つ。\n京極騒乱 - 応仁の乱の只中に発生した京極氏のお家騒動・内乱。\n第一次観音寺城の戦い\n第二次観音寺城の戦い\n第三次観音寺城の戦い\n原田城 - 東軍の拠点の1つ。\n天文法華の乱 - 天文5年（1536年）に京都で起こった宗教戦争。被害は応仁の乱以上とされている。\n京都の大火\n\n\n== 外部リンク ==\n\n應仁の亂に就て--内藤湖南（青空文庫）\n応仁の乱 コトバンク\nThe Ōnin War\u3000Visualizing 12 Years of War in Japan, 1465-78 ‐ 応仁の乱の各地戦乱地図、プリンストン大学'




```python
articles_overview[0][0]['url']
```




    'https://ja.wikipedia.org/wiki/%E5%BF%9C%E4%BB%81%E3%81%AE%E4%B9%B1'




```python
summary_text = articles_overview[0][0]['summary']
```


```python
def generate_wiki_outline(model_name, summary_text, related_search_results):
    # Wikipediaページのアウトラインを生成する関数
    prompt = [
        {"role": "system", "content": "You are an experienced Wikipedia writer and want to edit a specific page."},
        {"role": "system", "content": "Your task is to write an outline for a Wikipedia page based on a question summary and related search results."},
        {"role": "system", "content": "The outline should prioritize the question summary over related search results."},
        {"role": "system", "content": "Here is the format of your writing:"},
        {"role": "system", "content": "1. Use '#' Title ' to indicate section title, '##' Title ' to indicate subsection title, '###' Title ' to indicate subsubsection title, and so on."},
        {"role": "system", "content": "2. Do not include other information."},
        {"role": "user", "content": f"Question Summary: {summary_text}"},
        {"role": "user", "content": f"Related Search Results: {related_search_results}"},
        {"role": "system", "content": "Based on this information, please create a structured outline for the Wikipedia page."},
    ]

    response = client.chat.completions.create(
        model=model_name,
        messages=prompt,
        temperature=TEMPERATURE,
    )
    
    outline = response.choices[0].message.content
    
    return outline

```


```python
%%time
# outline_text = generate_wiki_outline(MODEL_NAME, summary_text, related_search_results)
outline_text = generate_wiki_outline(MODEL4o_NAME, summary_text, related_search_results)

print(outline_text)
```

    # 応仁の乱
    ## 概要
    ## 発生の背景
    ### 室町幕府の弱体化
    ### 足利将軍家の後継者問題
    ### 畠山氏と斯波氏の家督争い
    ## 主要な登場人物
    ### 細川勝元
    ### 山名宗全
    ### 足利義政
    ## 戦争の経過
    ### 初期の戦闘
    #### 京都での戦い
    ### 戦争の拡大
    #### 各地への広がり
    ## 経済的影響
    ### 経済的困窮と飢饉
    ### 借金帳消し令（徳政令）
    ## 社会的影響
    ### 地方武士の台頭
    ### 自治地域の形成
    ### 荘園制度の崩壊
    ## 戦後の影響
    ### 足利将軍家の衰退
    ### 戦国時代への移行
    ## 文化的影響
    ### 京都の荒廃と文化の変遷
    ### 銀閣寺の建設
    ## 現代の評価
    ### 応仁・文明の乱としての呼称
    ## 参考文献
    ## 外部リンク
    CPU times: user 13.5 ms, sys: 0 ns, total: 13.5 ms
    Wall time: 3.3 s



```python
def generate_detailed_outline(model_name, outline, summary_text, related_search_results):
    """
    Given a summary and related search results, enhance a Wikipedia page outline with detailed descriptions.
    
    Parameters:
    model_name (str): The model to be used for generating the descriptions.
    summary_text (str): Summary text providing a concise overview of the topic.
    related_search_results (str): Text containing related search results or additional contextual information.
    outline (str): The basic outline of the Wikipedia page.
    
    Returns:
    str: The enhanced outline with detailed descriptions for each section.
    """
    prompt = [
        {"role": "system", "content": "You are tasked with enhancing a Wikipedia page outline by integrating detailed descriptions based on a given summary and related search results."},
        {"role": "system", "content": "Ensure that your answer is unbiased and does not rely on stereotypes."},
        {"role": "system", "content": "Here is the basic outline of the page you need to expand with detailed explanations:"},
        {"role": "user", "content": outline},
        {"role": "system", "content": "Use the following summary and related search results to provide detailed descriptions for each section of the outline."},
        {"role": "user", "content": f"Summary: {summary_text}"},
        {"role": "user", "content": f"Related Search Results: {related_search_results}"},
        {"role": "system", "content": "Based on the summary and related search results, please add a comprehensive explanation for each section of the outline that includes historical context, significance of events, and relevant interpretations."}
    ]
    
    response = client.chat.completions.create(
        model=model_name,
        messages=prompt,
        temperature=TEMPERATURE,
    )
    
    detailed_outline = response.choices[0].message.content
    
    return detailed_outline

```


```python
%%time
# 生成したアウトラインに詳細な説明を加える
# detailed_outline = generate_detailed_outline(MODEL_NAME, outline_text, summary_text, related_search_results)
detailed_outline = generate_detailed_outline(MODEL4o_NAME, outline_text, summary_text, related_search_results)

print(detailed_outline)
```

    # 応仁の乱
    応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年間に及んで継続した内乱です。この戦乱は、室町幕府の権力構造を揺るがし、戦国時代への移行を促した重要な出来事でした。
    
    ## 概要
    応仁の乱は、室町幕府の管領家である畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となりました。この戦乱は、幕府勢力が東西に分かれて争う戦乱に発展し、各々の領国にも争いが拡大する大乱となりました。戦乱は最終的に西軍が解体されることで収束しましたが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃しました。
    
    ## 発生の背景
    ### 室町幕府の弱体化
    室町時代中期までに、幕府の権力は次第に弱体化していました。特に将軍家の内部抗争や経済的困窮がその一因となりました。幕府の権威が低下する中で、地方の守護大名たちが力を増し、中央の統制が効かなくなっていきました。
    
    ### 足利将軍家の後継者問題
    将軍足利義政には後継者がいなかったため、弟の足利義視が後継者とされました。しかし、その後、義政に実子（足利義尚）が生まれたことで後継者問題が深刻化しました。この争いは幕府内部の派閥闘争を引き起こし、応仁の乱の一因となりました。
    
    ### 畠山氏と斯波氏の家督争い
    畠山氏と斯波氏という有力な守護大名家の家督争いが、幕府内部の抗争と結びつくことで、戦乱の規模が拡大しました。これにより、幕府内の対立が深まり、全国的な内乱へと発展しました。
    
    ## 主要な登場人物
    ### 細川勝元
    細川勝元は、幕府の有力な守護大名であり、東軍の指導者として応仁の乱において重要な役割を果たしました。彼は幕府の実権を握り、義視を支持しました。
    
    ### 山名宗全
    山名宗全は、西軍の指導者であり、細川勝元と対立しました。彼は義尚を支持し、幕府の権力争いに深く関与しました。
    
    ### 足利義政
    足利義政は、応仁の乱の発端となった将軍であり、その後継者問題が戦乱の引き金となりました。乱の最中、義政は政治から退き、銀閣寺の建設など文化的な活動に力を注ぎました。
    
    ## 戦争の経過
    ### 初期の戦闘
    #### 京都での戦い
    1467年、応仁の乱が勃発すると、京都は激しい戦場となりました。東軍と西軍の間で激しい戦闘が繰り広げられ、京都全域が荒廃しました。
    
    ### 戦争の拡大
    #### 各地への広がり
    京都での戦いが激化する中、戦乱は全国各地に広がりました。地方の守護大名たちもそれぞれの利益を守るために戦いに参加し、乱の影響は全国に及びました。
    
    ## 経済的影響
    ### 経済的困窮と飢饉
    戦乱の長期化により、経済は大きな打撃を受けました。農地の荒廃や飢饉が発生し、庶民の生活は極度に困窮しました。
    
    ### 借金帳消し令（徳政令）
    経済的困窮に対処するため、将軍足利義政は徳政令を発布し、借金の帳消しを命じましたが、これにより経済の混乱がさらに深まりました。
    
    ## 社会的影響
    ### 地方武士の台頭
    戦乱を通じて、地方の武士たちが力を持ち、領土を支配する大名としての地位を確立しました。これにより、中央の権力がさらに弱体化しました。
    
    ### 自治地域の形成
    地方では、武士たちが自治的な地域を形成し、独自の統治体制を築きました。これにより、地方の独立性が高まりました。
    
    ### 荘園制度の崩壊
    戦乱により、従来の荘園制度が崩壊し、土地の所有形態が大きく変わりました。これにより、農民たちの生活も大きく影響を受けました。
    
    ## 戦後の影響
    ### 足利将軍家の衰退
    応仁の乱を経て、足利将軍家の権威は大きく低下しました。政治的な実権は次第に失われ、幕府の統制力が弱まることとなりました。
    
    ### 戦国時代への移行
    応仁の乱を契機に、戦乱が続く戦国時代へと移行しました。大名たちは自らの領地を拡大し、全国各地で対立が続く時代となりました。
    
    ## 文化的影響
    ### 京都の荒廃と文化の変遷
    戦乱によって京都は荒廃しましたが、一方で文化的な変遷も見られました。戦乱による影響で、新たな文化や芸術が生まれました。
    
    ### 銀閣寺の建設
    将軍足利義政は、政治から退いた後に銀閣寺を建設しました。これは、乱の中での文化的な象徴として重要な意味を持ちました。
    
    ## 現代の評価
    ### 応仁・文明の乱としての呼称
    応仁の乱は、その後の文明年間も続いたため、近年では「応仁・文明の乱」とも呼ばれます。この呼称は、戦乱の長期化とその影響の深刻さを象徴しています。
    
    ## 参考文献
    （ここに関連する文献のリストを挿入します）
    
    ## 外部リンク
    （ここに関連する外部リンクを挿入します）
    CPU times: user 9.71 ms, sys: 0 ns, total: 9.71 ms
    Wall time: 20.9 s



```python

```


```python
# outlineの分解
```


```python
# linguaを使用するとmarkdown記法を英語と判断してしまうのでナイーブベースで言語取得
from langdetect import detect

lang = detect(detailed_outline)
print(f"language: {lang}")
```

    language: ja



```python
def translate_to_japanese(model_name, detailed_outline):
    """
    Translates the detailed outline of a Wikipedia page from English to Japanese.
    
    Parameters:
    model_name (str): The model to be used for translation.
    detailed_outline (str): The detailed outline in English.
    
    Returns:
    str: The translated outline in Japanese.
    """
    prompt = [
        {"role": "system", "content": "You need to translate the following English text into Japanese."},
        {"role": "user", "content": detailed_outline},
        {"role": "system", "content": "Please provide the translation of the entire text into Japanese, maintaining the accuracy and context of the original information."}
    ]
    
    response = client.chat.completions.create(
        model=model_name,
        messages=prompt,
        temperature=TEMPERATURE,
    )
    
    translated_outline = response.choices[0].message.content
    
    return translated_outline
```


```python
%%time
if lang != "ja":
    translated_outline = translate_to_japanese(MODEL_NAME, detailed_outline)
else:
    translated_outline = detailed_outline
```

    CPU times: user 2 µs, sys: 0 ns, total: 2 µs
    Wall time: 4.05 µs



```python
print(translated_outline)
```

    # 応仁の乱
    応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年間に及んで継続した内乱です。この戦乱は、室町幕府の権力構造を揺るがし、戦国時代への移行を促した重要な出来事でした。
    
    ## 概要
    応仁の乱は、室町幕府の管領家である畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となりました。この戦乱は、幕府勢力が東西に分かれて争う戦乱に発展し、各々の領国にも争いが拡大する大乱となりました。戦乱は最終的に西軍が解体されることで収束しましたが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃しました。
    
    ## 発生の背景
    ### 室町幕府の弱体化
    室町時代中期までに、幕府の権力は次第に弱体化していました。特に将軍家の内部抗争や経済的困窮がその一因となりました。幕府の権威が低下する中で、地方の守護大名たちが力を増し、中央の統制が効かなくなっていきました。
    
    ### 足利将軍家の後継者問題
    将軍足利義政には後継者がいなかったため、弟の足利義視が後継者とされました。しかし、その後、義政に実子（足利義尚）が生まれたことで後継者問題が深刻化しました。この争いは幕府内部の派閥闘争を引き起こし、応仁の乱の一因となりました。
    
    ### 畠山氏と斯波氏の家督争い
    畠山氏と斯波氏という有力な守護大名家の家督争いが、幕府内部の抗争と結びつくことで、戦乱の規模が拡大しました。これにより、幕府内の対立が深まり、全国的な内乱へと発展しました。
    
    ## 主要な登場人物
    ### 細川勝元
    細川勝元は、幕府の有力な守護大名であり、東軍の指導者として応仁の乱において重要な役割を果たしました。彼は幕府の実権を握り、義視を支持しました。
    
    ### 山名宗全
    山名宗全は、西軍の指導者であり、細川勝元と対立しました。彼は義尚を支持し、幕府の権力争いに深く関与しました。
    
    ### 足利義政
    足利義政は、応仁の乱の発端となった将軍であり、その後継者問題が戦乱の引き金となりました。乱の最中、義政は政治から退き、銀閣寺の建設など文化的な活動に力を注ぎました。
    
    ## 戦争の経過
    ### 初期の戦闘
    #### 京都での戦い
    1467年、応仁の乱が勃発すると、京都は激しい戦場となりました。東軍と西軍の間で激しい戦闘が繰り広げられ、京都全域が荒廃しました。
    
    ### 戦争の拡大
    #### 各地への広がり
    京都での戦いが激化する中、戦乱は全国各地に広がりました。地方の守護大名たちもそれぞれの利益を守るために戦いに参加し、乱の影響は全国に及びました。
    
    ## 経済的影響
    ### 経済的困窮と飢饉
    戦乱の長期化により、経済は大きな打撃を受けました。農地の荒廃や飢饉が発生し、庶民の生活は極度に困窮しました。
    
    ### 借金帳消し令（徳政令）
    経済的困窮に対処するため、将軍足利義政は徳政令を発布し、借金の帳消しを命じましたが、これにより経済の混乱がさらに深まりました。
    
    ## 社会的影響
    ### 地方武士の台頭
    戦乱を通じて、地方の武士たちが力を持ち、領土を支配する大名としての地位を確立しました。これにより、中央の権力がさらに弱体化しました。
    
    ### 自治地域の形成
    地方では、武士たちが自治的な地域を形成し、独自の統治体制を築きました。これにより、地方の独立性が高まりました。
    
    ### 荘園制度の崩壊
    戦乱により、従来の荘園制度が崩壊し、土地の所有形態が大きく変わりました。これにより、農民たちの生活も大きく影響を受けました。
    
    ## 戦後の影響
    ### 足利将軍家の衰退
    応仁の乱を経て、足利将軍家の権威は大きく低下しました。政治的な実権は次第に失われ、幕府の統制力が弱まることとなりました。
    
    ### 戦国時代への移行
    応仁の乱を契機に、戦乱が続く戦国時代へと移行しました。大名たちは自らの領地を拡大し、全国各地で対立が続く時代となりました。
    
    ## 文化的影響
    ### 京都の荒廃と文化の変遷
    戦乱によって京都は荒廃しましたが、一方で文化的な変遷も見られました。戦乱による影響で、新たな文化や芸術が生まれました。
    
    ### 銀閣寺の建設
    将軍足利義政は、政治から退いた後に銀閣寺を建設しました。これは、乱の中での文化的な象徴として重要な意味を持ちました。
    
    ## 現代の評価
    ### 応仁・文明の乱としての呼称
    応仁の乱は、その後の文明年間も続いたため、近年では「応仁・文明の乱」とも呼ばれます。この呼称は、戦乱の長期化とその影響の深刻さを象徴しています。
    
    ## 参考文献
    （ここに関連する文献のリストを挿入します）
    
    ## 外部リンク
    （ここに関連する外部リンクを挿入します）



```python
def remove_duplicates_keep_order(original_list):
    seen = set()
    unique_list = []
    for item in original_list:
        if item not in seen:
            unique_list.append(item)
            seen.add(item)
    return unique_list
#     # 全リンクを一つのセットに統合する
#     unique_links = set()
#     for sublist in original_list:
#         unique_links.update(sublist)  # 各サブリストのリンクを追加

#     # セットをリストに変換
#     consolidated_list = list(unique_links)
    
#     return consolidated_list


# 重複を削除
last_search_links = []
last_search_links.append(articles_overview[0][0]['url'])

for link in related_search_links:
    last_search_links.append(link)


# 重複を削除
last_search_links = remove_duplicates_keep_order(last_search_links)
```


```python
last_search_links
```




    ['https://ja.wikipedia.org/wiki/%E5%BF%9C%E4%BB%81%E3%81%AE%E4%B9%B1',
     'https://www.britannica.com/event/Onin-War',
     'https://www.britannica.com/place/Japan/The-Onin-War-1467-77',
     'https://commons.princeton.edu/onin/',
     'https://www.metmuseum.org/toah/ht/08/eaj.html',
     'https://kansai-odyssey.com/onin-war-japans-longest-war/']




```python
translated_outline += "\n\n## 参考リンク\n"

for link in last_search_links:
    if len(link) > 5:
        translated_outline += "- " + str(link) + "\n"
```


```python
print(translated_outline)
```

    # 応仁の乱
    応仁の乱（おうにんのらん）は、室町時代中期の応仁元年（1467年）に発生し、文明9年（1477年）までの約11年間に及んで継続した内乱です。この戦乱は、室町幕府の権力構造を揺るがし、戦国時代への移行を促した重要な出来事でした。
    
    ## 概要
    応仁の乱は、室町幕府の管領家である畠山氏と斯波氏それぞれの家督争いに端を発し、足利将軍家の後継者問題も絡んで幕政の中心であった細川勝元と山名宗全の二大有力守護大名の抗争となりました。この戦乱は、幕府勢力が東西に分かれて争う戦乱に発展し、各々の領国にも争いが拡大する大乱となりました。戦乱は最終的に西軍が解体されることで収束しましたが、主要な戦場となった京都全域は壊滅的な被害を受けて荒廃しました。
    
    ## 発生の背景
    ### 室町幕府の弱体化
    室町時代中期までに、幕府の権力は次第に弱体化していました。特に将軍家の内部抗争や経済的困窮がその一因となりました。幕府の権威が低下する中で、地方の守護大名たちが力を増し、中央の統制が効かなくなっていきました。
    
    ### 足利将軍家の後継者問題
    将軍足利義政には後継者がいなかったため、弟の足利義視が後継者とされました。しかし、その後、義政に実子（足利義尚）が生まれたことで後継者問題が深刻化しました。この争いは幕府内部の派閥闘争を引き起こし、応仁の乱の一因となりました。
    
    ### 畠山氏と斯波氏の家督争い
    畠山氏と斯波氏という有力な守護大名家の家督争いが、幕府内部の抗争と結びつくことで、戦乱の規模が拡大しました。これにより、幕府内の対立が深まり、全国的な内乱へと発展しました。
    
    ## 主要な登場人物
    ### 細川勝元
    細川勝元は、幕府の有力な守護大名であり、東軍の指導者として応仁の乱において重要な役割を果たしました。彼は幕府の実権を握り、義視を支持しました。
    
    ### 山名宗全
    山名宗全は、西軍の指導者であり、細川勝元と対立しました。彼は義尚を支持し、幕府の権力争いに深く関与しました。
    
    ### 足利義政
    足利義政は、応仁の乱の発端となった将軍であり、その後継者問題が戦乱の引き金となりました。乱の最中、義政は政治から退き、銀閣寺の建設など文化的な活動に力を注ぎました。
    
    ## 戦争の経過
    ### 初期の戦闘
    #### 京都での戦い
    1467年、応仁の乱が勃発すると、京都は激しい戦場となりました。東軍と西軍の間で激しい戦闘が繰り広げられ、京都全域が荒廃しました。
    
    ### 戦争の拡大
    #### 各地への広がり
    京都での戦いが激化する中、戦乱は全国各地に広がりました。地方の守護大名たちもそれぞれの利益を守るために戦いに参加し、乱の影響は全国に及びました。
    
    ## 経済的影響
    ### 経済的困窮と飢饉
    戦乱の長期化により、経済は大きな打撃を受けました。農地の荒廃や飢饉が発生し、庶民の生活は極度に困窮しました。
    
    ### 借金帳消し令（徳政令）
    経済的困窮に対処するため、将軍足利義政は徳政令を発布し、借金の帳消しを命じましたが、これにより経済の混乱がさらに深まりました。
    
    ## 社会的影響
    ### 地方武士の台頭
    戦乱を通じて、地方の武士たちが力を持ち、領土を支配する大名としての地位を確立しました。これにより、中央の権力がさらに弱体化しました。
    
    ### 自治地域の形成
    地方では、武士たちが自治的な地域を形成し、独自の統治体制を築きました。これにより、地方の独立性が高まりました。
    
    ### 荘園制度の崩壊
    戦乱により、従来の荘園制度が崩壊し、土地の所有形態が大きく変わりました。これにより、農民たちの生活も大きく影響を受けました。
    
    ## 戦後の影響
    ### 足利将軍家の衰退
    応仁の乱を経て、足利将軍家の権威は大きく低下しました。政治的な実権は次第に失われ、幕府の統制力が弱まることとなりました。
    
    ### 戦国時代への移行
    応仁の乱を契機に、戦乱が続く戦国時代へと移行しました。大名たちは自らの領地を拡大し、全国各地で対立が続く時代となりました。
    
    ## 文化的影響
    ### 京都の荒廃と文化の変遷
    戦乱によって京都は荒廃しましたが、一方で文化的な変遷も見られました。戦乱による影響で、新たな文化や芸術が生まれました。
    
    ### 銀閣寺の建設
    将軍足利義政は、政治から退いた後に銀閣寺を建設しました。これは、乱の中での文化的な象徴として重要な意味を持ちました。
    
    ## 現代の評価
    ### 応仁・文明の乱としての呼称
    応仁の乱は、その後の文明年間も続いたため、近年では「応仁・文明の乱」とも呼ばれます。この呼称は、戦乱の長期化とその影響の深刻さを象徴しています。
    
    ## 参考文献
    （ここに関連する文献のリストを挿入します）
    
    ## 外部リンク
    （ここに関連する外部リンクを挿入します）
    
    ## 参考リンク
    - https://ja.wikipedia.org/wiki/%E5%BF%9C%E4%BB%81%E3%81%AE%E4%B9%B1
    - https://www.britannica.com/event/Onin-War
    - https://www.britannica.com/place/Japan/The-Onin-War-1467-77
    - https://commons.princeton.edu/onin/
    - https://www.metmuseum.org/toah/ht/08/eaj.html
    - https://kansai-odyssey.com/onin-war-japans-longest-war/
    



```python
MODEL_ENBEDDING_NAME = "text-embedding-3-small"
```


```python
def get_embedding(text, model="text-embedding-3-small"):
    text = text.replace("\n", " ")
    return client.embeddings.create(input = [text], model=model).data[0].embedding
```


```python
message_embedding = get_embedding(message, model=MODEL_ENBEDDING_NAME)
```


```python
# translated_embedding_outline = get_embedding(translated_outline[:7000], model=MODEL_ENBEDDING_NAME)
translated_embedding_outline = get_embedding(translated_outline, model=MODEL_ENBEDDING_NAME)
# translated_embedding_outline = get_embedding(translated_outline, model="text-embedding-3-large")
# translated_embedding_outline = get_embedding(updated_outline_text, model=MODEL_ENBEDDING_NAME)

```


```python
import numpy as np

def cosine_similarity(vector_a, vector_b):
    dot_product = np.dot(vector_a, vector_b)
    norm_a = np.linalg.norm(vector_a)
    norm_b = np.linalg.norm(vector_b)
    similarity = dot_product / (norm_a * norm_b)
    return similarity
```


```python
len(message_embedding), len(translated_embedding_outline)
```




    (1536, 1536)




```python
# Calculating the cosine similarity
cosine_similarity_result = cosine_similarity(message_embedding, translated_embedding_outline)
cosine_similarity_result
```




    0.6061413645640154




```python
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity

def cosine_similarity_fixed(vector_a, vector_b):
    """
    Calculate cosine similarity between two vectors ensuring proper 2D shapes.
    """
    vector_a = np.array(vector_a).reshape(1, -1)
    vector_b = np.array(vector_b).reshape(1, -1)
    return cosine_similarity(vector_a, vector_b)[0][0]

def calculate_intersection(embedding_a, embedding_b):
    """
    Approximate the soft cardinality of the intersection of two sets of embeddings.
    """
    return cosine_similarity_fixed(embedding_a, embedding_b)

def soft_cardinality(embedding):
    """
    Calculate the soft cardinality for a set of embeddings.
    Each element's weight is inversely proportional to the sum of its cosine similarities with all other elements.
    """
    embedding = np.array(embedding).reshape(1, -1)  # Ensure embedding is 2D
    cosine_sim = cosine_similarity(embedding, embedding)
    weights = 1 / cosine_sim.sum(axis=1)
    return weights.sum()

def soft_precision(reference_embedding, predicted_embedding):
    """
    Calculate soft precision using embeddings of reference and predicted sets.
    """
    intersection = calculate_intersection(predicted_embedding, reference_embedding)
    predicted_cardinality = soft_cardinality(predicted_embedding)
    return intersection / predicted_cardinality

def soft_recall(reference_embedding, predicted_embedding):
    """
    Calculate soft recall using embeddings of reference and predicted sets.
    """
    intersection = calculate_intersection(predicted_embedding, reference_embedding)
    reference_cardinality = soft_cardinality(reference_embedding)
    return intersection / reference_cardinality

```


```python
# ソフトプレシジョンとソフトリコールの計算
precision = soft_precision(translated_embedding_outline, message_embedding)
recall = soft_recall(translated_embedding_outline, message_embedding)

print("Soft Precision:", precision)
print("Soft Recall:", recall)

```

    Soft Precision: 0.6061413645640159
    Soft Recall: 0.6061413645640159



```python

```
